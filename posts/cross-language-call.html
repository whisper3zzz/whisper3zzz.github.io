<!DOCTYPE html><html lang="en" data-beasties-container><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="/favicon.svg"><script>!function(){const e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=localStorage.getItem("vueuse-color-scheme")||"auto";("dark"===t||e&&"light"!==t)&&document.documentElement.classList.toggle("dark",!0)}()</script><style type="text/css">:root{color-scheme:light dark;--va-c-bg:#fff}html{background-color:var(--va-c-bg)}.sakura-search-btn{z-index:200}.sakura-dropdown[data-v-4c068fa2]{position:relative;display:inline-block}.sakura-nav-link[data-v-9e758860]{display:flex;align-items:center;color:inherit}.sakura-nav-link[data-v-9e758860]:hover{color:var(--sakura-color-primary)}.sakura-navbar-link-item[data-v-eeb1ce95]{display:flex;justify-content:center;font-size:15px;color:inherit;margin-inline:.75rem}.sakura-navbar-link-item>.sakura-nav-link[data-v-eeb1ce95]:after{content:"";position:absolute;width:0;left:0;bottom:0;height:var(--sakura-navbar-marker-height);background-color:var(--sakura-navbar-marker-color);transition:width .3s ease}.sakura-navbar-link-item>.sakura-nav-link[data-v-eeb1ce95]:hover:after{width:100%}.sakura-navbar-link[data-v-9a8e7c84]{display:none;height:100%;font-size:.875rem;color:var(--sakura-navbar-item-color);line-height:1.25rem;transform:translate(0)}.sakura-navbar-link .marker[data-v-9a8e7c84]{position:absolute;border-bottom:var(--sakura-navbar-marker-height) solid var(--sakura-color-primary);transition-property:opacity,left,top;transition-duration:.5s;pointer-events:none;height:100%}@media screen and (min-width:768px){.sakura-navbar-link[data-v-9a8e7c84]{display:flex}}.sakura-navbar-brand[data-v-648c0e72]{display:flex;align-items:center;white-space:nowrap}.sakura-navbar-brand .logo-link[data-v-648c0e72]{color:var(--sakura-navbar-title-color);font-size:20px;font-weight:600;line-height:normal;transition:font-size .3s ease,font-weight .3s ease}@media screen and (min-width:768px){.sakura-navbar-brand .logo-link[data-v-648c0e72]{font-size:22px;font-weight:800}}@media screen and (min-width:1024px){.sakura-navbar-brand .logo-link[data-v-648c0e72]{font-size:24px}}.sakura-navbar-brand .logo-link span[data-v-648c0e72]{display:inline-block}.sakura-navbar-brand .logo-link span[data-v-648c0e72]:first-child{border-radius:9px}.sakura-navbar-brand .logo-link:hover span[data-v-648c0e72]:first-child{background-color:var(--sakura-color-primary);color:var(--sakura-navbar-bg)}.sakura-navbar-brand .logo-link:hover span[data-v-648c0e72]:not(:first-child){color:var(--sakura-color-primary)}.sakura-navbar-brand .navbar-title[data-v-648c0e72]{ruby-position:under;font-variant-ligatures:no-common-ligatures}.mobile-btn[data-v-2637eb86]{width:20px;height:22px;display:flex;justify-content:space-between;flex-direction:column;transition:transform .3s}.mobile-btn span[data-v-2637eb86]{position:relative;width:100%;height:5px;border-radius:20px}.mobile-btn span[data-v-2637eb86]:first-child,.mobile-btn span[data-v-2637eb86]:nth-child(3){width:50%;align-self:flex-end;transform-origin:left;transition:transform .3s}.mobile-btn span[data-v-2637eb86]:first-child{align-self:flex-start;transform-origin:right}.sakura-navbar .navbar-content{height:var(--sakura-navbar-height);transition:all var(--va-transition-duration) ease-in}.sakura-navbar .navbar-content.active-header{background:var(--sakura-navbar-bg)}.sakura-navbar-tools>:not(:last-child){margin-right:8px}.sakura-navbar .sakura-nav-link-icon{height:1em;width:1em;margin-right:.2rem}.sakura-navbar .sakura-navbar-tools{color:var(--sakura-navbar-item-color)}.sakura-sidebar-offset[data-v-73ded2f2]{transform:translate(var(--sakura-private-sidebar-offset));transition:transform var(--va-transition-duration) cubic-bezier(.19,1,.22,1)}.sakura-sidebar-link-items .sakura-sidebar-link-item[data-v-c8f18fb2]{padding:6px 15px;color:var(--sakura-color-text);font-size:14px;letter-spacing:.02em}.sakura-sidebar-link-items .sakura-sidebar-link-item[data-v-c8f18fb2]:hover{color:var(--sakura-color-primary)}.sakura-sidebar-link[data-v-0bc3e539]{display:flex;overflow:hidden;white-space:nowrap;text-align:center}.links-of-author[data-v-3450e641]{display:flex;flex-wrap:wrap;justify-content:center}.links-of-author .icon[data-v-3450e641]{width:1.2rem;height:1.2rem}.links-of-author-item[data-v-3450e641]{line-height:1;font-size:.9rem}.sakura-sidebar[data-v-0fb8bf6e]{position:fixed;z-index:1000;padding-top:30px;width:var(--sakura-sidebar-width);background-image:var(--sakura-c-sidebar-bg-img);background-position:bottom 1rem center;background-color:var(--sakura-sidebar-bg);transition:box-shadow var(--va-transition-duration),background-color var(--va-transition-duration),opacity .25s,transform var(--va-transition-duration) cubic-bezier(.19,1,.22,1)!important}.sakura-sidebar.left[data-v-0fb8bf6e]{transform:translate(-100%)}.sakura-sidebar .sakura-copyright[data-v-0fb8bf6e]{font-size:12px}*,:after,:before{box-sizing:border-box;border-width:0;border-style:solid;border-color:var(--un-default-border-color,#e5e7eb)}html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif,system-ui,sans-serif,"Apple Color Emoji","Segoe UI Emoji",Segoe UI Symbol,"Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}a{color:inherit;text-decoration:inherit}button{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;color:inherit;margin:0;padding:0}button{text-transform:none}[type=button],button{-webkit-appearance:button;background-image:none}dd,dl,h2,h4{margin:0}ul{list-style:none;margin:0;padding:0}button{cursor:pointer}body{counter-reset:katexEqnNo mmlEqnNo}:root{--va-c-border:#c2c2c4;--va-c-divider:#e2e2e3;--va-c-gutter:#e2e2e3}:root{--va-c-gray-1:#dddde3;--va-c-gray-2:#e4e4e9;--va-c-gray-3:#ebebef;--va-c-gray-soft:rgba(142, 150, 170, .14);--va-c-indigo-1:#3451b2;--va-c-indigo-2:#3a5ccc;--va-c-indigo-3:#5672cd;--va-c-indigo-soft:rgba(100, 108, 255, .14);--va-c-green-1:#18794e;--va-c-green-2:#299764;--va-c-green-3:#30a46c;--va-c-green-soft:rgba(16, 185, 129, .14);--va-c-yellow-1:#915930;--va-c-yellow-2:#946300;--va-c-yellow-3:#9f6a00;--va-c-yellow-soft:rgba(234, 179, 8, .14);--va-c-red-1:#b8272c;--va-c-red-2:#d5393e;--va-c-red-3:#e0575b;--va-c-red-soft:rgba(244, 63, 94, .14);--va-c-sponsor:#db2777}:root{--va-c-default-1:var(--va-c-gray-1);--va-c-default-2:var(--va-c-gray-2);--va-c-default-3:var(--va-c-gray-3);--va-c-default-soft:var(--va-c-gray-soft);--va-c-brand-1:var(--va-c-indigo-1);--va-c-brand-2:var(--va-c-indigo-2);--va-c-brand-3:var(--va-c-indigo-3);--va-c-brand-soft:var(--va-c-indigo-soft);--va-c-brand:var(--va-c-brand-1);--va-c-tip-1:var(--va-c-brand-1);--va-c-tip-2:var(--va-c-brand-2);--va-c-tip-3:var(--va-c-brand-3);--va-c-tip-soft:var(--va-c-brand-soft);--va-c-warning-1:var(--va-c-yellow-1);--va-c-warning-2:var(--va-c-yellow-2);--va-c-warning-3:var(--va-c-yellow-3);--va-c-warning-soft:var(--va-c-yellow-soft);--va-c-danger-1:var(--va-c-red-1);--va-c-danger-2:var(--va-c-red-2);--va-c-danger-3:var(--va-c-red-3);--va-c-danger-soft:var(--va-c-red-soft)}:root{--va-aside-width:256px;--va-sidebar-width:300px;--va-border-width:1px;--va-font-serif:"Noto Serif SC",DM Serif Display,STZhongsong,STKaiti,KaiTi,Roboto,serif;--va-font-sans:DM Sans,Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",sans-serif;--va-font-mono:DM Mono,Menlo,Monaco,Consolas,"Courier New",monospace;--va-transition-duration-fast:.2s;--va-transition-duration:.4s;--va-transition-duration-slow:.6s;--va-transition:all var(--va-transition-duration-fast) ease-in-out}:root{--va-c-white:#fff;--va-c-black:#1a1a1a;--va-c-gray:#8e8e8e;--va-c-danger:#db2828;--va-c-warning:#f2711c;--va-c-text-light-1:#213547;--va-c-text-light-2:rgba(60, 60, 60, .7);--va-c-text-light-3:rgba(60, 60, 60, .33);--va-c-text-light-4:rgba(60, 60, 60, .18);--va-c-text-dark-1:rgba(255, 255, 255, .87);--va-c-text-dark-2:rgba(235, 235, 235, .6);--va-c-text-dark-3:rgba(235, 235, 235, .38);--va-c-text-dark-4:rgba(235, 235, 235, .18);--va-c-primary-light:rgb(255, 159.7559055118, 24.6);--va-c-primary-lighter:rgb(255, 170.3385826772, 50.2);--va-c-primary-dark:rgb(228.6, 134.1, 0);--va-c-primary:#fe9500}:root{color-scheme:light;--va-c-brand:#fe9500;--va-border-color:#222;--va-c-text:#333;--va-c-text-light:#555;--va-c-text-lighter:#666;--va-c-text-dark:#111;--va-c-primary-rgb:254,149,0;--va-c-link:var(--va-c-primary-dark)}:root{--va-c-text-1:rgba(60, 60, 67);--va-c-text-2:rgba(60, 60, 67, .78);--va-c-text-3:rgba(60, 60, 67, .56)}:root{--va-c-bg:#ffffff;--va-c-bg-light:#ffffff;--va-c-bg-dark:#fafafa;--va-c-bg-opacity:rgba(255, 255, 255, .8);--va-c-bg-soft:#f9f9f9;--va-c-bg-alt:#f9f9f9;--va-c-bg-mute:#f1f1f1}:root{--va-code-line-height:1.7;--va-code-font-size:.875em;--va-code-block-color:var(--va-c-text-2);--va-code-block-bg:var(--va-c-bg-alt);--va-code-block-divider-color:var(--va-c-gutter);--va-code-lang-color:var(--va-c-text-3);--va-code-line-highlight-color:var(--va-c-default-soft);--va-code-line-number-color:var(--va-c-text-3);--va-code-line-diff-add-color:var(--va-c-green-soft);--va-code-line-diff-add-symbol-color:var(--va-c-green-1);--va-code-line-diff-remove-color:var(--va-c-red-soft);--va-code-line-diff-remove-symbol-color:var(--va-c-red-1);--va-code-line-warning-color:var(--va-c-yellow-soft);--va-code-line-error-color:var(--va-c-red-soft);--va-code-copy-code-border-color:var(--va-c-divider);--va-code-copy-code-bg:var(--va-c-bg-soft);--va-code-copy-code-hover-border-color:var(--va-c-divider);--va-code-copy-code-hover-bg:var(--va-c-bg);--va-code-copy-code-active-text:var(--va-c-text-2);--va-code-copy-copied-text-content:"Copied";--va-code-tab-divider:var(--va-code-block-divider-color);--va-code-tab-text-color:var(--va-c-text-2);--va-code-tab-bg:var(--va-code-block-bg);--va-code-tab-hover-text-color:var(--va-c-text-1);--va-code-tab-active-text-color:var(--va-c-text-1);--va-code-tab-active-bar-color:var(--va-c-brand-1)}:root{--va-icon-copy:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' height='20' width='20' stroke='rgba(128,128,128,1)' stroke-width='2' class='h-6 w-6' viewBox='0 0 24 24'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2'/%3E%3C/svg%3E");--va-icon-copied:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' height='20' width='20' stroke='rgba(128,128,128,1)' stroke-width='2' class='h-6 w-6' viewBox='0 0 24 24'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2m-6 9 2 2 4-4'/%3E%3C/svg%3E");--va-icon-collapse:url("data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20width='32'%20height='32' stroke='rgba(128,128,128,1)' viewBox='0%200%2024%2024'%3E%3Cpath%20fill='currentColor'%20d='m12%2016.175l3.9-3.875q.275-.275.688-.288t.712.288q.275.275.275.7t-.275.7l-4.6%204.6q-.15.15-.325.213t-.375.062q-.2%200-.375-.063T11.3%2018.3l-4.6-4.6q-.275-.275-.288-.687T6.7%2012.3q.275-.275.7-.275t.7.275l3.9%203.875Zm0-6L15.9%206.3q.275-.275.688-.287t.712.287q.275.275.275.7t-.275.7l-4.6%204.6q-.15.15-.325.213t-.375.062q-.2%200-.375-.062T11.3%2012.3L6.7%207.7q-.275-.275-.288-.688T6.7%206.3q.275-.275.7-.275t.7.275l3.9%203.875Z'/%3E%3C/svg%3E")}:root{--va-header-anchor-symbol:"#"}html{-webkit-tap-highlight-color:transparent;font-family:var(--va-font-sans)}a{color:var(--va-c-link);font-weight:500}*{outline:0}button{background-color:transparent}#app,body,html{margin:0;padding:0;line-height:2}html{background-color:var(--va-c-bg)}a{cursor:pointer}:root{--un-prose-links:var(--sakura-color-action);--un-prose-body:var(--sakura-color-text);--va-z-overlay:var(--sakura-backdrop-z, 2);--sakura-color-text-muted:oklch(70% 0 0deg);--sakura-color-text:oklch(55.55% 0 0deg);--sakura-color-text-deep:oklch(37.15% 0 0deg);--sakura-color-border:oklch(94.91% 0 0deg);--sakura-color-icon:oklch(100% 0 0deg);--sakura-color-divider:oklch(94.31% 0 0deg);--sakura-card-bg:oklch(100% 0 0deg / .98);--sakura-font-family:Rubik,sans-serif;--sakura-color-primary:var(--va-c-primary);--sakura-color-action:var(--va-c-primary-dark);--sakura-color-background:var(--va-c-bg);--sakura-color-main-background:var(--va-c-bg);--sakura-color-muted-background:var(--va-c-bg-mute);--sakura-color-overlay-background:oklch(16.83% .0061 248.19deg / .75);--sakura-scrollbar-bg:var(--sakura-color-background);--sakura-scrollbar-thumb:var(--sakura-color-primary);--sakura-scrollbar-thumb-hover:oklch(67.17% .0163 271.17deg);--sakura-radius:10px;--sakura-radius-large:15px;--sakura-radius-small:5px;--sakura-navbar-bg:var(--sakura-card-bg);--sakura-navbar-height:65px;--sakura-navbar-marker-height:2px;--sakura-navbar-marker-color:var(--sakura-color-primary);--sakura-navbar-mt:20px;--sakura-navbar-spacing:calc(var(--sakura-navbar-height) + 20px);--sakura-navbar-shadow:0 10px 20px -8px oklch(0% 0 0deg / .5);--sakura-navbar-title-color:var(--sakura-color-text-deep);--sakura-navbar-item-color:var(--sakura-color-text);--sakura-footer-height:140px;--sakura-card-shadow:0px 20px 26px oklch(33% .0014 17.23deg / .3);--sakura-post-card-height:250px;--sakura-post-card-bg:var(--sakura-card-bg);--sakura-post-card-img-width:55%;--sakura-post-card-rd:var(--sakura-radius);--sakura-post-card-font-size:1.17em;--sakura-post-nav-height:150px;--sakura-aside-width:var(--va-sidebar-width);--sakura-sidebar-width:var(--va-sidebar-width);--sakura-sidebar-marker-height:2px;--sakura-sidebar-bg:var(--sakura-color-background);--sakura-sidebar-offset:var(--sakura-sidebar-width);--sakura-timeline-color:var(--sakura-color-primary);--sakura-timeline-text-color:var(--sakura-color-primary);--sakura-timeline-height:30px;--sakura-color-glitch-before:oklch(66% .2 32.5deg);--sakura-color-glitch-after:oklch(66% .2 252deg);--sakura-comment-bg-url:url(/assets/comment-bg.CpQHGW7d.png);--va-font-family-base:"Chinese Quotes","Inter var","Inter",ui-sans-serif,system-ui,-apple-system,blinkmacsystemfont,"Segoe UI",roboto,"Helvetica Neue",helvetica,arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji"}:root{--vp-code-block-bg:var(--va-c-bg-alt);--vp-code-tab-divider:var(--va-c-gutter)}.link{color:var(--sakura-color-primary)}html{color:var(--sakura-color-text)}body{font-family:var(--sakura-font-family);text-shadow:0 0 1px oklch(0 0 0deg / .1)}@media(max-width:767px){body{min-width:320px}}body::-webkit-scrollbar-thumb{background:var(--sakura-color-primary)}a{color:var(--sakura-color-primary);transition:color .2s ease-out}a:hover{color:var(--sakura-color-action)}.sakura-safe-padding{padding-inline:max(20px,env(safe-area-inset-left));transition:padding var(--va-transition-duration) ease}@media screen and (min-width:640px){.sakura-safe-padding{padding-inline:max(40px,env(safe-area-inset-left))}}@property --a{syntax:"<angle>";inherits:false;initial-value:100turn}@property --i{syntax:"<number>";inherits:false;initial-value:1}.sakura-icon-btn{background-color:transparent;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;border:none;width:2rem;height:2rem;transition:color var(--va-transition-duration)}.sakura-icon-btn div{font-size:1.2rem}.sakura-icon-btn:active,.sakura-icon-btn:hover{color:var(--sakura-color-primary)}.sakura-main{background-color:var(--sakura-color-main-background);background-image:var(--sakura-custom-bg);background-size:cover;background-position:center;background-attachment:fixed;height:100%;width:100%}body{background-color:var(--sakura-color-main-background);background-image:var(--sakura-c-body-bg-img);background-size:cover;background-position:center;background-attachment:fixed;height:100%;width:100%}.site-author-avatar{display:inline-block;line-height:0;position:relative}.site-author-avatar img{height:96px;width:96px;max-width:100%;margin:0;padding:4px;background-color:#fff;box-shadow:0 0 10px #0003;transition:var(--va-transition-duration)}.site-author-avatar img:hover{box-shadow:0 0 30px var(--sakura-color-primary)}.site-author-status{position:absolute;height:1.8rem;width:1.8rem;bottom:0;right:0;line-height:1.8rem;border-radius:50%;box-shadow:0 1px 2px #0003;background-color:var(--va-c-bg-light);border:1px solid oklch(100% 0 0deg / .1)}.site-name{color:var(--va-c-text);font-family:get-css-var("font-serif");font-weight:900}.site-subtitle{color:get-css-var("color-primary");display:block}.site-description{color:var(--va-c-text);font-size:.8rem}.sakura-braced-text{position:relative;padding-inline:calc(1rem + 6px);word-break:break-all;-webkit-hyphens:auto;hyphens:auto}.sakura-braced-text:before{content:"{";color:var(--sakura-color-primary);font-family:Helvetica,sans-serif;position:absolute;left:0;top:0}.sakura-braced-text:after{content:"}";color:var(--sakura-color-primary);font-family:Helvetica,sans-serif;position:absolute;right:0;bottom:0}@media(min-device-width:600px){*{scrollbar-color:var(--sakura-scrollbar-thumb) var(--sakura-scrollbar-bg)}body::-webkit-scrollbar{width:12px;height:12px;background-color:var(--sakura-scrollbar-bg)}}.sakura-preload{animation-duration:0s!important;transition:background-color 0s,opacity 0s,color 0s,width 0s,height 0s,padding 0s,margin 0s!important}.sakura-triple-columns-base.sakura-triple-columns{grid-template-columns:0 1fr 0;display:grid;grid-template-rows:1fr;gap:0}@media screen and (min-width:768px){.sakura-triple-columns-base.sakura-triple-columns{gap:0 12px}}:root{--prose-max-width:65ch;--prose-width:min(var(--prose-max-width), 100%);--prose-margin:calc(calc(100vw - var(--prose-width)) / 2)}.prose{color:var(--sakura-color-text);max-width:var(--prose-max-width);font-size:1rem;line-height:1.75}html{--vp-icon-copy:url("data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 fill=%27none%27 height=%2720%27 width=%2720%27 stroke=%27rgba(128,128,128,1)%27 stroke-width=%272%27 viewBox=%270 0 24 24%27%3E%3Cpath stroke-linecap=%27round%27 stroke-linejoin=%27round%27 d=%27M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2%27/%3E%3C/svg%3E");--vp-icon-copied:url("data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 fill=%27none%27 height=%2720%27 width=%2720%27 stroke=%27rgba(128,128,128,1)%27 stroke-width=%272%27 viewBox=%270 0 24 24%27%3E%3Cpath stroke-linecap=%27round%27 stroke-linejoin=%27round%27 d=%27M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2m-6 9 2 2 4-4%27/%3E%3C/svg%3E")}:root{--va-custom-block-font-size:14px;--va-custom-block-code-font-size:13px;--va-custom-block-info-border:transparent;--va-custom-block-info-text:var(--va-c-text-1);--va-custom-block-info-bg:var(--va-c-default-soft);--va-custom-block-info-code-bg:var(--va-c-default-soft);--va-custom-block-tip-border:transparent;--va-custom-block-tip-text:var(--va-c-text-1);--va-custom-block-tip-bg:var(--va-primary-color-soft);--va-custom-block-tip-code-bg:var(--va-primary-color-soft);--va-custom-block-warning-border:transparent;--va-custom-block-warning-text:var(--va-c-text-1);--va-custom-block-warning-bg:var(--va-c-warning-soft);--va-custom-block-warning-code-bg:var(--va-c-warning-soft);--va-custom-block-danger-border:transparent;--va-custom-block-danger-text:var(--va-c-text-1);--va-custom-block-danger-bg:var(--va-c-danger-soft);--va-custom-block-danger-code-bg:var(--va-c-danger-soft);--va-custom-block-details-border:var(--va-custom-block-info-border);--va-custom-block-details-text:var(--va-custom-block-info-text);--va-custom-block-details-bg:var(--va-custom-block-info-bg);--va-custom-block-details-code-bg:var(--va-custom-block-info-code-bg)}:root{--progressive-image-background-color:var(--sakura-color-divider);--progressive-image-blur:16px;--progressive-image-fade-ease:cubic-bezier(.39, .57, .56, 1);--progressive-image-fade-speed:.45s;--progressive-image-skeleton-speed:1.85s;--progressive-image-skeleton-background:linear-gradient( 90deg, oklch(100% 0 0 / 0%) 0%, oklch(100% 0 0 / 70%) 70%, oklch(100% 0 0 / 0%) 100% )}@supports ((-webkit-hyphens:none) and (not (margin-trim:inline))) or ((-moz-orient:inline) and (not (color:rgb(from red r g b)))){*,:after,:before{--un-ease:initial;--un-leading:initial;--un-scale-x:1;--un-scale-y:1;--un-scale-z:1;--un-rotate-x:rotateX(0);--un-rotate-y:rotateY(0);--un-rotate-z:rotateZ(0);--un-skew-x:skewX(0);--un-skew-y:skewY(0);--un-bg-opacity:100%;--un-text-opacity:100%;--un-space-y-reverse:initial;--un-border-opacity:100%}}@property --un-text-opacity{syntax:"<percentage>";inherits:falseinitial-value:100%}@property --un-leading{syntax:"*"inherits:false}@property --un-outline-style{syntax:"*";inherits:falseinitial-value:solid}@property --un-border-opacity{syntax:"<percentage>";inherits:falseinitial-value:100%}@property --un-bg-opacity{syntax:"<percentage>";inherits:falseinitial-value:100%}@property --un-inset-ring-color{syntax:"*"inherits:false}@property --un-inset-ring-shadow{syntax:"*";inherits:falseinitial-value:0 0 #0000}@property --un-inset-shadow{syntax:"*";inherits:falseinitial-value:0 0 #0000}@property --un-inset-shadow-color{syntax:"*"inherits:false}@property --un-ring-color{syntax:"*"inherits:false}@property --un-ring-inset{syntax:"*"inherits:false}@property --un-ring-offset-color{syntax:"*"inherits:false}@property --un-ring-offset-shadow{syntax:"*";inherits:falseinitial-value:0 0 #0000}@property --un-ring-offset-width{syntax:"<length>";inherits:falseinitial-value:0px}@property --un-ring-shadow{syntax:"*";inherits:falseinitial-value:0 0 #0000}@property --un-shadow{syntax:"*";inherits:falseinitial-value:0 0 #0000}@property --un-shadow-color{syntax:"*"inherits:false}@property --un-rotate-x{syntax:"*";inherits:falseinitial-value:rotateX(0)}@property --un-rotate-y{syntax:"*";inherits:falseinitial-value:rotateY(0)}@property --un-rotate-z{syntax:"*";inherits:falseinitial-value:rotateZ(0)}@property --un-skew-x{syntax:"*";inherits:falseinitial-value:skewX(0)}@property --un-skew-y{syntax:"*";inherits:falseinitial-value:skewY(0)}@property --un-scale-x{syntax:"*";inherits:falseinitial-value:1}@property --un-scale-y{syntax:"*";inherits:falseinitial-value:1}@property --un-scale-z{syntax:"*";inherits:falseinitial-value:1}@property --un-ease{syntax:"*"inherits:false}@property --un-blur{syntax:"*"inherits:false}@property --un-brightness{syntax:"*"inherits:false}@property --un-contrast{syntax:"*"inherits:false}@property --un-drop-shadow{syntax:"*"inherits:false}@property --un-grayscale{syntax:"*"inherits:false}@property --un-hue-rotate{syntax:"*"inherits:false}@property --un-invert{syntax:"*"inherits:false}@property --un-saturate{syntax:"*"inherits:false}@property --un-sepia{syntax:"*"inherits:false}@property --un-space-y-reverse{syntax:"*";inherits:falseinitial-value:0}:root{--spacing:.25rem;--default-transition-timingFunction:cubic-bezier(.4, 0, .2, 1);--default-transition-duration:.15s;--ease-DEFAULT:cubic-bezier(.4, 0, .2, 1);--ease-out:cubic-bezier(0, 0, .2, 1);--ease-in-out:cubic-bezier(.4, 0, .2, 1);--radius-DEFAULT:.25rem;--ease-in:cubic-bezier(.4, 0, 1, 1);--fontWeight-bold:700;--colors-red-400:oklch(70.4% .191 22.216);--colors-gray-DEFAULT:oklch(70.7% .022 261.325);--text-lg-fontSize:1.125rem;--text-lg-lineHeight:1.75rem;--text-sm-fontSize:.875rem;--text-sm-lineHeight:1.25rem;--text-base-fontSize:1rem;--text-base-lineHeight:1.5rem;--text-2xl-fontSize:1.5rem;--text-2xl-lineHeight:2rem;--fontWeight-black:900;--text-xs-fontSize:.75rem;--text-xs-lineHeight:1rem;--text-xl-fontSize:1.25rem;--text-xl-lineHeight:1.75rem;--container-sm:24rem;--colors-white:#fff;--colors-gray-600:oklch(44.6% .03 256.802);--font-sans:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--font-mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;--default-font-family:var(--font-sans);--default-monoFont-family:var(--font-mono)}*,:after,:before{box-sizing:border-box;margin:0;padding:0;border:0 solid}html{line-height:1.5;-webkit-text-size-adjust:100%;tab-size:4;font-family:var( --default-font-family, ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji" );font-feature-settings:var(--default-font-featureSettings,normal);font-variation-settings:var(--default-font-variationSettings,normal);-webkit-tap-highlight-color:transparent}h2,h4{font-size:inherit;font-weight:inherit}a{color:inherit;-webkit-text-decoration:inherit;text-decoration:inherit}ul{list-style:none}img{display:block;vertical-align:middle}img{max-width:100%;height:auto}button{font:inherit;font-feature-settings:inherit;font-variation-settings:inherit;letter-spacing:inherit;color:inherit;border-radius:0;background-color:transparent;opacity:1}button{appearance:button}.i-fa-chain{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 1664 1664' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M1456 1216q0-40-28-68l-208-208q-28-28-68-28q-42 0-72 32q3 3 19 18.5t21.5 21.5t15 19t13 25.5t3.5 27.5q0 40-28 68t-68 28q-15 0-27.5-3.5t-25.5-13t-19-15t-21.5-21.5t-18.5-19q-33 31-33 73q0 40 28 68l206 207q27 27 68 27q40 0 68-26l147-146q28-28 28-67M753 511q0-40-28-68L519 236q-28-28-68-28q-39 0-68 27L236 381q-28 28-28 67q0 40 28 68l208 208q27 27 68 27q42 0 72-31q-3-3-19-18.5T543.5 680t-15-19t-13-25.5T512 608q0-40 28-68t68-28q15 0 27.5 3.5t25.5 13t19 15t21.5 21.5t18.5 19q33-31 33-73m895 705q0 120-85 203l-147 146q-83 83-203 83q-121 0-204-85l-206-207q-83-83-83-203q0-123 88-209l-88-88q-86 88-208 88q-120 0-204-84L100 652q-84-84-84-204t85-203L248 99q83-83 203-83q121 0 204 85l206 207q83 83 83 203q0 123-88 209l88 88q86-88 208-88q120 0 204 84l208 208q84 84 84 204'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-fa6-solid-image=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 512 512' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M0 96c0-35.3 28.7-64 64-64h384c35.3 0 64 28.7 64 64v320c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64zm323.8 106.5c-4.5-6.6-11.9-10.5-19.8-10.5s-15.4 3.9-19.8 10.5l-87 127.6l-26.5-33.1c-4.6-5.7-11.5-9-18.7-9s-14.2 3.3-18.7 9l-64 80c-5.8 7.2-6.9 17.1-2.9 25.4S78.8 416 88 416h336c8.9 0 17.1-4.9 21.2-12.8s3.6-17.4-1.4-24.7zM112 192a48 48 0 1 0 0-96a48 48 0 1 0 0 96'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-line-md-moon-alt-to-sunny-outline-loop-transition{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cg fill='none' stroke='currentColor' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'%3E%3Cpath stroke-dasharray='2' stroke-dashoffset='2' d='M12 19v1M19 12h1M12 5v-1M5 12h-1'%3E%3Canimate fill='freeze' attributeName='d' begin='0.6s' dur='0.2s' values='M12 19v1M19 12h1M12 5v-1M5 12h-1;M12 21v1M21 12h1M12 3v-1M3 12h-1'/%3E%3Canimate fill='freeze' attributeName='stroke-dashoffset' begin='0.6s' dur='0.2s' values='2;0'/%3E%3C/path%3E%3Cpath stroke-dasharray='2' stroke-dashoffset='2' d='M17 17l0.5 0.5M17 7l0.5 -0.5M7 7l-0.5 -0.5M7 17l-0.5 0.5'%3E%3Canimate fill='freeze' attributeName='d' begin='0.8s' dur='0.2s' values='M17 17l0.5 0.5M17 7l0.5 -0.5M7 7l-0.5 -0.5M7 17l-0.5 0.5;M18.5 18.5l0.5 0.5M18.5 5.5l0.5 -0.5M5.5 5.5l-0.5 -0.5M5.5 18.5l-0.5 0.5'/%3E%3Canimate fill='freeze' attributeName='stroke-dashoffset' begin='0.8s' dur='0.2s' values='2;0'/%3E%3C/path%3E%3CanimateTransform attributeName='transform' dur='30s' repeatCount='indefinite' type='rotate' values='0 12 12;360 12 12'/%3E%3C/g%3E%3Cmask id='SVGpCD1890p'%3E%3Ccircle cx='12' cy='12' r='12' fill='%23fff'/%3E%3Ccircle cx='12' cy='12' r='8'%3E%3Canimate fill='freeze' attributeName='r' dur='0.4s' values='8;4'/%3E%3C/circle%3E%3Ccircle cx='18' cy='6' r='12' fill='%23fff'%3E%3Canimate fill='freeze' attributeName='cx' dur='0.4s' values='18;22'/%3E%3Canimate fill='freeze' attributeName='cy' dur='0.4s' values='6;2'/%3E%3Canimate fill='freeze' attributeName='r' dur='0.4s' values='12;3'/%3E%3C/circle%3E%3Ccircle cx='18' cy='6' r='10'%3E%3Canimate fill='freeze' attributeName='cx' dur='0.4s' values='18;22'/%3E%3Canimate fill='freeze' attributeName='cy' dur='0.4s' values='6;2'/%3E%3Canimate fill='freeze' attributeName='r' dur='0.4s' values='10;1'/%3E%3C/circle%3E%3C/mask%3E%3Ccircle cx='12' cy='12' r='10' mask='url(%23SVGpCD1890p)' fill='currentColor'%3E%3Canimate fill='freeze' attributeName='r' dur='0.4s' values='10;6'/%3E%3C/circle%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-mdi\:clock-outline=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12 20a8 8 0 0 0 8-8a8 8 0 0 0-8-8a8 8 0 0 0-8 8a8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10a10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67l-.75 1.23L11 13V7z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-mdi-search=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5l-1.5 1.5l-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16A6.5 6.5 0 0 1 3 9.5A6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14S14 12 14 9.5S12 5 9.5 5'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-archive-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M3 10H2V4.003C2 3.449 2.455 3 2.992 3h18.016A.99.99 0 0 1 22 4.003V10h-1v10.002a.996.996 0 0 1-.993.998H3.993A.996.996 0 0 1 3 20.002zm16 0H5v9h14zM4 5v3h16V5zm5 7h6v2H9z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-bilibili-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M7.172 2.757L10.414 6h3.171l3.243-3.242a1 1 0 1 1 1.415 1.415L16.414 6H18.5A3.5 3.5 0 0 1 22 9.5v8a3.5 3.5 0 0 1-3.5 3.5h-13A3.5 3.5 0 0 1 2 17.5v-8A3.5 3.5 0 0 1 5.5 6h2.085L5.757 4.171a1 1 0 0 1 1.415-1.415M18.5 8h-13a1.5 1.5 0 0 0-1.493 1.356L4 9.5v8a1.5 1.5 0 0 0 1.356 1.493L5.5 19h13a1.5 1.5 0 0 0 1.493-1.355L20 17.5v-8A1.5 1.5 0 0 0 18.5 8M8 11a1 1 0 0 1 1 1v2a1 1 0 1 1-2 0v-2a1 1 0 0 1 1-1m8 0a1 1 0 0 1 1 1v2a1 1 0 1 1-2 0v-2a1 1 0 0 1 1-1'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-eye-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12 3c5.392 0 9.878 3.88 10.819 9c-.94 5.12-5.427 9-10.819 9s-9.878-3.88-10.818-9C2.122 6.88 6.608 3 12 3m0 16a9.005 9.005 0 0 0 8.778-7a9.005 9.005 0 0 0-17.555 0A9.005 9.005 0 0 0 12 19m0-2.5a4.5 4.5 0 1 1 0-9a4.5 4.5 0 0 1 0 9m0-2a2.5 2.5 0 1 0 0-5a2.5 2.5 0 0 0 0 5'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-folder-2-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12.414 5H21a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h7.414zM20 11H4v8h16zm0-2V7h-8.414l-2-2H4v4z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-github-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M5.884 18.653c-.3-.2-.558-.455-.86-.816a51 51 0 0 1-.466-.579c-.463-.575-.755-.841-1.056-.95a1 1 0 1 1 .675-1.882c.752.27 1.261.735 1.947 1.588c-.094-.117.34.427.433.539c.19.227.33.365.44.438c.204.137.588.196 1.15.14c.024-.382.094-.753.202-1.095c-2.968-.726-4.648-2.64-4.648-6.396c0-1.24.37-2.356 1.058-3.292c-.218-.894-.185-1.975.302-3.192a1 1 0 0 1 .63-.582c.081-.024.127-.035.208-.047c.803-.124 1.937.17 3.415 1.096a11.7 11.7 0 0 1 2.687-.308c.912 0 1.819.104 2.684.308c1.477-.933 2.614-1.227 3.422-1.096q.128.02.218.05a1 1 0 0 1 .616.58c.487 1.216.52 2.296.302 3.19c.691.936 1.058 2.045 1.058 3.293c0 3.757-1.674 5.665-4.642 6.392c.125.415.19.878.19 1.38c0 .665-.002 1.299-.007 2.01c0 .19-.002.394-.005.706a1 1 0 0 1-.018 1.958c-1.14.227-1.984-.532-1.984-1.525l.002-.447l.005-.705c.005-.707.008-1.337.008-1.997c0-.697-.184-1.152-.426-1.361c-.661-.57-.326-1.654.541-1.751c2.966-.333 4.336-1.482 4.336-4.66c0-.955-.312-1.744-.913-2.404A1 1 0 0 1 17.2 6.19c.166-.414.236-.957.095-1.614l-.01.003c-.491.139-1.11.44-1.858.949a1 1 0 0 1-.833.135a9.6 9.6 0 0 0-2.592-.349c-.89 0-1.772.118-2.592.35a1 1 0 0 1-.829-.134c-.753-.507-1.374-.807-1.87-.947c-.143.653-.072 1.194.093 1.607a1 1 0 0 1-.189 1.045c-.597.655-.913 1.458-.913 2.404c0 3.172 1.371 4.328 4.322 4.66c.865.097 1.202 1.177.545 1.748c-.193.168-.43.732-.43 1.364v3.15c0 .985-.834 1.725-1.96 1.528a1 1 0 0 1-.04-1.962v-.99c-.91.061-1.661-.088-2.254-.485'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-home-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M21 20a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9.49a1 1 0 0 1 .386-.79l8-6.223a1 1 0 0 1 1.228 0l8 6.223a1 1 0 0 1 .386.79zm-2-1V9.978l-7-5.444l-7 5.444V19z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-mail-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M3 3h18a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1m17 4.238l-7.928 7.1L4 7.216V19h16zM4.511 5l7.55 6.662L19.502 5z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-netease-cloud-music-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M10.422 11.375c-.294 1.028.012 2.065.784 2.653c1.061.81 2.565.3 2.874-.995c.08-.337.103-.722.027-1.056c-.23-1.001-.521-1.988-.792-2.996c-1.33.154-2.543 1.172-2.893 2.394m5.548-.287c.273 1.012.285 2.017-.127 3c-1.128 2.69-4.722 3.14-6.573.826c-1.302-1.627-1.28-3.961.06-5.734c.78-1.032 1.804-1.707 3.048-2.054l.379-.104c-.084-.415-.188-.816-.243-1.224c-.176-1.317.512-2.503 1.744-3.04c1.226-.535 2.708-.216 3.53.76c.406.479.395 1.08-.025 1.464c-.412.377-.997.346-1.435-.09c-.247-.246-.51-.44-.877-.436c-.525.006-.987.418-.945.937c.037.468.172.93.3 1.386c.022.078.216.135.338.153c1.333.197 2.504.731 3.472 1.676c2.558 2.493 2.861 6.531.672 9.44c-1.529 2.032-3.61 3.169-6.127 3.409c-4.621.44-8.664-2.53-9.7-7.058C2.516 10.255 4.84 5.831 8.796 4.25c.586-.234 1.143-.031 1.371.498c.232.537-.019 1.086-.61 1.35c-2.368 1.06-3.817 2.855-4.215 5.424c-.533 3.433 1.656 6.776 5 7.72c2.723.77 5.658-.166 7.308-2.33c1.586-2.08 1.4-5.099-.427-6.873A4 4 0 0 0 15.4 9.026c.198.716.389 1.388.57 2.062'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-price-tag-3-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m10.904 2.1l9.9 1.414l1.414 9.9l-9.192 9.192a1 1 0 0 1-1.415 0l-9.9-9.9a1 1 0 0 1 0-1.413zm.707 2.122L3.833 12l8.485 8.485l7.779-7.778l-1.061-7.425zm2.122 6.363a2 2 0 1 1 2.828-2.828a2 2 0 0 1-2.828 2.829'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-translate{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M5 15v2a2 2 0 0 0 1.85 1.994L7 19h3v2H7a4 4 0 0 1-4-4v-2zm13-5l4.4 11h-2.155l-1.201-3h-4.09l-1.199 3h-2.154L16 10zm-1 2.885L15.753 16h2.492zM8 2v2h4v7H8v3H6v-3H2V4h4V2zm9 1a4 4 0 0 1 4 4v2h-2V7a2 2 0 0 0-2-2h-3V3zM6 6H4v3h2zm4 0H8v3h2z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.flex-center,[flex~=center]{display:flex;align-items:center;justify-content:center}.inline-flex-center{display:inline-flex;align-items:center;justify-content:center}[text~=sm]{font-size:var(--text-sm-fontSize);line-height:var(--un-leading, var(--text-sm-lineHeight))}[text~=xs]{font-size:var(--text-xs-fontSize);line-height:var(--un-leading, var(--text-xs-lineHeight))}.text-\$sakura-color-text{color:color-mix(in oklab,var(--sakura-color-text) var(--un-text-opacity),transparent)}.leading-6{--un-leading:calc(var(--spacing) * 6);line-height:calc(var(--spacing) * 6)}[font~=black]{--un-font-weight:var(--fontWeight-black);font-weight:var(--fontWeight-black)}[m~="2"]{margin:calc(var(--spacing) * 2)}.mx-auto{margin-inline:auto}.my-1{margin-block:calc(var(--spacing) * 1)}[m~=b-4]{margin-bottom:calc(var(--spacing) * 4)}.mr-0\.5{margin-right:calc(var(--spacing) * .5)}.mr-1,[mr1=""]{margin-right:calc(var(--spacing) * 1)}.mr-4{margin-right:calc(var(--spacing) * 4)}.mt-4{margin-top:calc(var(--spacing) * 4)}[m~=l-1]{margin-left:calc(var(--spacing) * 1)}[m~=t-0]{margin-top:calc(var(--spacing) * 0)}[p~="1"]{padding:calc(var(--spacing) * 1)}.py-8{padding-block:calc(var(--spacing) * 8)}[py~="1"]{padding-block:calc(var(--spacing) * 1)}.pb-25px{padding-bottom:25px}[text~=center]{text-align:center}.align-top{vertical-align:top}.rounded-full{border-radius:calc(infinity * 1px)}.rounded-l-\$sakura-radius{border-top-left-radius:var(--sakura-radius);border-bottom-left-radius:var(--sakura-radius)}.rounded-r-\$sakura-radius{border-top-right-radius:var(--sakura-radius);border-bottom-right-radius:var(--sakura-radius)}.bg-\$sakura-color-action{background-color:color-mix(in oklab,var(--sakura-color-action) var(--un-bg-opacity),transparent)}.bg-\$sakura-color-background{background-color:color-mix(in oklab,var(--sakura-color-background) var(--un-bg-opacity),transparent)}.opacity-70{opacity:70%}.flex,[flex=""],[flex~="~"]{display:flex}[flex~=inline],[inline-flex=""]{display:inline-flex}.flex-col,[flex~=col]{flex-direction:column}[flex~=wrap]{flex-wrap:wrap}[flex~=gap-x-4]{column-gap:calc(var(--spacing) * 4)}.grid{display:grid}.h-\$sakura-footer-height{height:var(--sakura-footer-height)}.h-full,[h-full=""],[h~=full]{height:100%}.max-w-none{max-width:none}.min-w-0{min-width:calc(var(--spacing) * 0)}.w-1\/2{width:50%}.w-full,[w~=full]{width:100%}[h~="30%"]{height:30%}[w~="30%"]{width:30%}.block{display:block}.inline-block{display:inline-block}.select-none{-webkit-user-select:none;user-select:none}.whitespace-nowrap{white-space:nowrap}[truncate=""]{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.antialiased{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.transform{transform:var(--un-rotate-x) var(--un-rotate-y) var(--un-rotate-z) var(--un-skew-x) var(--un-skew-y)}.transition{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,--un-gradient-from,--un-gradient-via,--un-gradient-to,opacity,box-shadow,transform,translate,scale,rotate,filter,-webkit-backdrop-filter,backdrop-filter;transition-timing-function:var(--un-ease,var(--default-transition-timingFunction));transition-duration:var(--un-duration, var(--default-transition-duration))}[flex~=items-end]{align-items:flex-end}.items-center,[flex~=items-center]{align-items:center}.justify-center,[flex~=justify-center]{justify-content:center}[flex~=justify-between]{justify-content:space-between}.inset-y-0{inset-block:calc(var(--spacing) * 0)}.top-0,[top-0=""]{top:calc(var(--spacing) * 0)}[justify-end=""]{justify-content:flex-end}.absolute{position:absolute}[fixed=""]{position:fixed}.relative{position:relative}.z-1{z-index:1}[z-100=""]{z-index:100}.overflow-hidden{overflow:hidden}.overflow-y-auto{overflow-y:auto}[bg~=contain]{background-size:contain}[bg~=no-repeat]{background-repeat:no-repeat}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border-width:0}[font~=serif]{font-family:var(--va-font-serif)}@media print{[print\:op0=""]{opacity:0%}}@media (max-width:calc(64rem - .1px)){.\<lg\:hidden{display:none}}@media (max-width:calc(48rem - .1px)){.\<md\:hidden{display:none}}@media(min-width:48rem){.md\:hidden{display:none}}.sakura-aside[data-v-aead835b]{position:sticky;top:calc(var(--sakura-navbar-height) + var(--sakura-navbar-mt));padding-top:var(--sakura-navbar-mt);max-height:calc(100dvh - var(--sakura-navbar-height));transition:box-shadow var(--va-transition-duration),background-color var(--va-transition-duration),opacity .25s,transform var(--va-transition-duration) cubic-bezier(.19,1,.22,1),top var(--va-transition-duration);overflow-y:auto;padding-bottom:2rem;background-color:var(--sakura-color-background)}.root[data-v-81d0e566]{position:relative;z-index:1}.va-toc[data-v-a0b02666]{text-align:left}.content[data-v-a0b02666]{position:relative;padding-left:16px;font-size:14px;text-align:left}.outline-marker[data-v-a0b02666]{position:absolute;top:32px;left:-2px;z-index:0;opacity:0;width:4px;height:18px;background-color:var(--sakura-color-primary);transition:top .25s cubic-bezier(0,1,.5,1),background-color .5s,opacity .25s}.outline-title[data-v-a0b02666]{letter-spacing:.4px;line-height:28px;font-size:14px;font-weight:600}.visually-hidden[data-v-a0b02666]{position:absolute;width:1px;height:1px;white-space:nowrap;clip:rect(0 0 0 0);clip-path:inset(50%);overflow:hidden}.sakura-post-nav[data-v-fcca7734]{width:100%}.sakura-post-nav-content[data-v-fcca7734]{display:flex;flex-direction:column;justify-content:center;height:100%;margin-left:2.5rem;margin-right:2.5rem}.sakura-post-nav-content[data-v-fcca7734]>*{z-index:2}.sakura-post-nav-label[data-v-fcca7734]{font-size:.75rem;line-height:1rem;letter-spacing:.025em;text-transform:uppercase;color:#ffffffb3}.sakura-post-nav-title[data-v-fcca7734]{color:#f1f8fd;font-weight:700}.sakura-post-nav .sakura-image-card[data-v-fcca7734]{height:var(--sakura-post-nav-height);width:100%;border-radius:0}.sakura-post-nav .sakura-image-card[data-v-fcca7734]:before{content:"";transition:opacity .3s ease-in-out;background-color:var(--sakura-color-overlay-background);opacity:.6;position:absolute;inset:0;z-index:1;pointer-events:none}.sakura-post-nav .sakura-image-card[data-v-fcca7734]:hover:before{opacity:.4}.sakura-post-footer[data-v-f99429f0]{border-style:none}.sakura-post .sakura-page-content{max-width:800px;padding-block:24px}@media screen and (min-width:768px){.sakura-post .sakura-triple-columns{grid-template-columns:150px minmax(0,800px) 150px!important}}@media screen and (min-width:1024px){.sakura-post .sakura-triple-columns{grid-template-columns:250px minmax(0,800px) 250px!important}}.sakura-title[data-v-f4310435]{font-size:1.8rem;font-weight:700;color:var(--sakura-color-text-deep)}@media screen and (min-width:640px){.sakura-title[data-v-f4310435]{font-size:2.3rem}}.sakura-page-header[data-v-8dd1a56f]{margin-top:var(--sakura-navbar-height);width:100%;position:relative}.sakura-page-header[data-v-8dd1a56f]:not(.has-cover){margin-top:var(--sakura-navbar-spacing)}.sakura-page-header:not(.has-cover) .sakura-header-title[data-v-8dd1a56f]{justify-content:center}.sakura-page-header .sakura-header-container[data-v-8dd1a56f]{color:#fff}.sakura-page{transform-style:preserve-3d}.sakura-page-content{background:var(--sakura-color-background);border-radius:var(--sakura-radius)}@media screen and (min-width:768px){.sakura-page .sakura-triple-columns{grid-template-columns:150px 1fr 150px}}@media screen and (min-width:1024px){.sakura-page .sakura-triple-columns{grid-template-columns:250px 1fr 250px}}.sakura-post-date[data-v-3049e252] *{color:inherit;font-size:inherit;cursor:auto}</style><script>const locale=localStorage.getItem("valaxy-locale")||"zh-CN";document.documentElement.setAttribute("lang",locale)</script><script type="module" async crossorigin src="/assets/app.JCnF4OTK.js"></script><link rel="modulepreload" crossorigin href="/assets/framework.hWCtYY1X.js"><link rel="modulepreload" crossorigin href="/assets/chunks/pinia.gM4CtPT_.js"><link rel="modulepreload" crossorigin href="/assets/chunks/vue-router.COYb0BJC.js"><link rel="modulepreload" crossorigin href="/assets/chunks/dayjs.BdcnXKr1.js"><link rel="modulepreload" crossorigin href="/assets/chunks/vue-i18n.DXR2i9JP.js"><link rel="modulepreload" crossorigin href="/assets/chunks/nprogress.Bru8d7fl.js"><link rel="preload" crossorigin href="/assets/app.CDWOmTH6.css" onload='this.rel="stylesheet"' as="style"><noscript><link rel="stylesheet" crossorigin href="/assets/app.CDWOmTH6.css"></noscript><link rel="preload" crossorigin href="/assets/group-icons.Bm1YPxXM.css" onload='this.rel="stylesheet"' as="style"><noscript><link rel="stylesheet" crossorigin href="/assets/group-icons.Bm1YPxXM.css"></noscript><link rel="modulepreload" crossorigin href="/assets/post.puixgEAb.js"><link rel="preload" href="/assets/post.BB-a_kKN.css" onload='this.rel="stylesheet"' as="style"><noscript><link rel="stylesheet" href="/assets/post.BB-a_kKN.css"></noscript><link rel="preload" href="/assets/group-icons.Bm1YPxXM.css" onload='this.rel="stylesheet"' as="style"><noscript><link rel="stylesheet" href="/assets/group-icons.Bm1YPxXM.css"></noscript><link rel="modulepreload" crossorigin href="/assets/SakuraPage.vue_vue_type_style_index_0_lang.e6uhAlR7.js"><link rel="preload" href="/assets/SakuraPage.5MfKNlt_.css" onload='this.rel="stylesheet"' as="style"><noscript><link rel="stylesheet" href="/assets/SakuraPage.5MfKNlt_.css"></noscript><link rel="modulepreload" crossorigin href="/assets/SakuraPostDate.Dcd-DMWE.js"><link rel="preload" href="/assets/SakuraPostDate.CQWV6bLq.css" onload='this.rel="stylesheet"' as="style"><noscript><link rel="stylesheet" href="/assets/SakuraPostDate.CQWV6bLq.css"></noscript><link rel="modulepreload" crossorigin href="/assets/index.BVwoFtQh.js"><link rel="modulepreload" crossorigin href="/assets/SakuraImageCard.ia8YN7uI.js"><link rel="preload" href="/assets/SakuraImageCard.BLnZWf0n.css" onload='this.rel="stylesheet"' as="style"><noscript><link rel="stylesheet" href="/assets/SakuraImageCard.BLnZWf0n.css"></noscript><title>漫谈跨语言调用 - whisper3zzzの小窝</title><script id="check-mac-os" async>document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform))</script><link rel="stylesheet" href="https://unpkg.com/aplayer/dist/APlayer.min.css"><meta property="og:locale:alternate" content="en"><meta name="description" content="whisper3zzzの小窝"><meta property="og:description" content="whisper3zzzの小窝"><meta property="og:locale" content="zh-CN"><meta property="og:site_name" content="whisper3zzzの小窝"><meta property="og:title" content="漫谈跨语言调用"><meta property="og:image" content="/favicon.svg"><meta property="og:type" content="website"><meta property="og:url" content="https://whisper3zzz.top/"><link rel="icon" href="/favicon.svg" type="image/svg+xml"><meta name="generator" content="Valaxy 0.26.6"><meta name="theme-color" content="#fff"><meta name="msapplication-TileColor" content="#fff"><meta name="twitter:card" content="summary_large_image"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_AMS-Regular.BQhdFMY1.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Caligraphic-Bold.Dq_IR9rO.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Caligraphic-Regular.Di6jR-x-.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Fraktur-Bold.CL6g_b3V.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Fraktur-Regular.CTYiF6lA.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Main-Bold.Cx986IdX.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Main-BoldItalic.DxDJ3AOS.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Main-Italic.NWA7e6Wa.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Main-Regular.B22Nviop.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Math-BoldItalic.CZnvNsCZ.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Math-Italic.t53AETM-.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_SansSerif-Bold.D1sUS0GD.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_SansSerif-Italic.C3H0VqGB.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_SansSerif-Regular.DDBCnlJ7.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Script-Regular.D3wIWfF6.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Size1-Regular.mCD8mA8B.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Size2-Regular.Dy4dx90m.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="data:font/woff2;base64,d09GMgABAAAAAA4oAA4AAAAAHbQAAA3TAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAABmAAgRQIDgmcDBEICo1oijYBNgIkA14LMgAEIAWJAAeBHAyBHBvbGiMRdnO0IkRRkiYDgr9KsJ1NUAf2kILNxgUmgqIgq1P89vcbIcmsQbRps3vCcXdYOKSWEPEKgZgQkprQQsxIXUgq0DqpGKmIvrgkeVGtEQD9DzAO29fM9jYhxZEsL2FeURH2JN4MIcTdO049NCVdxQ/w9NrSYFEBKTDKpLKfNkCGDc1RwjZLQcm3vqJ2UW9Xfa3tgAHz6ivp6vgC2yD4/6352ndnN0X0TL7seypkjZlMsjmZnf0Mm5Q+JykRWQBKCVCVPbARPXWyQtb5VgLB6Biq7/Uixcj2WGqdI8tGSgkuRG+t910GKP2D7AQH0DB9FMDW/obJZ8giFI3Wg8Cvevz0M+5m0rTh7XDBlvo9Y4vm13EXmfttwI4mBo1EG15fxJhUiCLbiiyCf/ZA6MFAhg3pGIZGdGIVjtPn6UcMk9A/UUr9PhoNsCENw1APAq0gpH73e+M+0ueyHbabc3vkbcdtzcf/fiy+NxQEjf9ud/ELBHAXJ0nk4z+MXH2Ev/kWyV4k7SkvpPc9Qr38F6RPWnM9cN6DJ0AdD1BhtgABtmoRoFCvPsBAumNm6soZG2Gk5GyVTo2sJncSyp0jQTYoR6WDvTwaaEcHsxHfvuWhHA3a6bN7twRKtcGok6NsCi7jYRrM2jExsUFMxMQYuJbMhuWNOumEJy9hi29Dmg5zMp/A5+hhPG19j1vBrq8JTLr8ki5VLPmG/PynJHVul440bxg5xuymHUFPBshC+nA9I1FmwbRBTNHAcik3Oae0cxKoI3MOriM42UrPe51nsaGxJ+WfXubAsP84aabUlQSJ1IiE0iPETLUU4CATgfXSCSpuRFRmCGbO+wSpAnzaeaCYW1VNEysRtuXCEL1kUFUbbtMv3Tilt/1c11jt3Q5bbMa84cpWipp8Elw3MZhOHsOlwwVUQM3lAR35JiFQbaYCRnMF2lxAWoOg2gyoIV4PouX8HytNIfLhqpJtXB4vjiViUI8IJ7bkC4ikkQvKksnOTKICwnqWSZ9YS5f0WCxmpgjbIq7EJcM4aI2nmhLNY2JIUgOjXZFWBHb+x5oh6cwb0Tv1ackHdKi0I9OO2wE9aogIOn540CCCziyhN+IaejtgAONKznHlHyutPrHGwCx9S6B8kfS4Mfi4Eyv7OU730bT1SCBjt834cXsf43zVjPUqqJjgrjeGnBxSG4aYAKFuVbeCfkDIjAqMb6yLNIbCuvXhMH2/+k2vkNpkORhR59N1CkzoOENvneIosjYmuTxlhUzaGEJQ/iWqx4dmwpmKjrwTiTGTCVozNAYqk/zXOndWxuWSmJkQpJw3pK5KX6QrLt5LATMqpmPAQhkhK6PUjzHUn7E0gHE0kPE0iKkolgkUx9SZmVAdDgpffdyJKg3k7VmzYGCwVXGz/tXmkOIp+vcWs+EMuhhvN0h9uhfzWJziBQmCREGSIFmQIkgVpAnSBRmC//6hkLZwaVhwxlrJSOdqlFtOYxlau9F2QN5Y98xmIAsiM1HVp2VFX+DHHGg6Ecjh3vmqtidX3qHI2qycTk/iwxSt5UzTmEP92ZBnEWTk4Mx8Mpl78ZDokxg/KWb+Q0QkvdKVmq3TMW+RXEgrsziSAfNXFMhDc60N5N9jQzjfO0kBKpUZl0ZmwJ41j/B9Hz6wmRaJB84niNmQrzp9eSlQCDDzazGDdVi3P36VZQ+Jy4f9UBNp+3zTjqI4abaFAm+GShVaXlsGdF3FYzZcDI6cori4kMxUECl9IjJZpzkvitAoxKue+90pDMvcKRxLl53TmOKCmV/xRolNKSqqUxc6LStOETmFOiLZZptlZepcKiAzteG8PEdpnQpbOMNcMsR4RR2Bs0cKFEvSmIjAFcnarqwUL4lDhHmnVkwu1IwshbiCcgvOheZuYyOteufZZwlcTlLgnZ3o/WcYdzZHW/WGaqaVfmTZ1aWCceJjkbZqsfbkOtcFlUZM/jy+hXHDbaUobWqqXaeWobbLO99yG5N3U4wxco0rQGGcOLASFMXeJoham8M+/x6O2WywK2l4HGbq1CoUyC/IZikQhdq3SiuNrvAEj0AVu9x2x3lp/xWzahaxidezFVtdcb5uEnzyl0ZmYiuKI0exvCd4Xc9CV1KB0db00z92wDPde0kukbvZIWN6jUWFTmPIC/Y4UPCm8UfDTFZpZNon1qLFTkBhxzB+FjQRA2Q/YRJT8pQigslMaUpFyAG8TMlXigiqmAZX4xgijKjRlGpLE0GdplRfCaJo0JQaSxNBk6ZmMzcya0FmrcisDdn0Q3HI2sWSppYigmlM1XT/kLQZSNpMJG0WkjYbSZuDpM1F0uYhFc1HxU4m1QJjDK6iL0S5uSj5rgXc3RejEigtcRBtqYPQsiTskmO5vosV+q4VGIKbOkDg0jtRrq+Em1YloaTFar3EGr1EUC8R0kus1Uus00usL97ABr2BjXoDm/QGNhuWtMVBKOwg/i78lT7hBsAvDmwHc/ao3vmUbBmhjeYySZNWvGkfZAgISDSaDo1SVpzGDsAEkF8B+gEapViUoZgUWXcRIGFZNm6gWbAKk0bp0k1MHG9fLYtV4iS2SmLEQFARzRcnf9PUS0LVn05/J9MiRRBU3v2IrvW974v4N00L7ZMk0wXP1409CHo/an8zTRHD3eSJ6m8D4YMkZNl3M79sqeuAsr/m3f+8/yl7A50aiAEJgeBeMWzu7ui9UfUBCe2TIqZIoOd/3/udRBOQidQZUERzb2/VwZN1H/Sju82ew2H2Wfr6qvfVf3hqwDvAIpkQVFy4B9Pe9e4/XvPeceu7h3dvO56iJPf0+A6cqA2ip18ER+iFgggiuOkvj24bby0N9j2UHIkgqIt+sVgfodC4YghLSMjSZbH0VR/6dMDrYJeKHilKTemt6v6kvzvn3/RrdWtr0GoN/xL+Sex/cPYLUpepx9cz/D46UPU5KXgAQa+NDps1v6J3xP1i2HtaDB0M9aX2deA7SYff//+gUCovMmIK/qfsFcOk+4Y5ZN97XlG6zebqtMbKgeRFi51vnxTQYBUik2rS/Cn6PC8ADR8FGxsRPB82dzfND90gIcshOcYUkfjherBz53odpm6TP8txlwOZ71xmfHHOvq053qFF/MRlS3jP0ELudrf2OeN8DHvp6ZceLe8qKYvWz/7yp0u4dKPfli3CYq0O13Ih71mylJ80tOi10On8wi+F4+LWgDPeJ30msSQt9/vkmHq9/Lvo2b461mP801v3W4xTcs6CbvF9UDdrSt+A8OUbpSh55qAUFXWznBBfdeJ8a4d7ugT5tvxUza3h9m4H7ptTqiG4z0g5dc0X29OcGlhpGFMpQo9ytTS+NViZpNdvU4kWx+LKxNY10kQ1yqGXrhe4/1nvP7E+nd5A92TtaRplbHSqoIdOqtRWti+fkB5/n1+/VvCmz12pG1kpQWsfi1ftlBobm0bpngs16CHkbIwdLnParxtTV3QYRlfJ0KFskH7pdN/YDn+yRuSd7sNH3aO0DYPggk6uWuXrfOc+fa3VTxFVvKaNxHsiHmsXyCLIE5yuOeN3/Jdf8HBL/5M6shjyhxHx9BjB1O0+4NLOnjLLSxwO7ukN4jMbOIcD879KLSi6Pk61Oqm2377n8079PXEEQ7cy7OKEC9nbpet118fxweTafpt69x/Bt8UqGzNQt7aelpc44dn5cqhwf71+qKp/Zf/+a0zcizOUWpl/iBcSXip0pplkatCchoH5c5aUM8I7/dWxAej8WicPL1URFZ9BDJelUwEwTkGqUhgSlydVes95YdXvhh9Gfz/aeFWvgVb4tuLbcv4+wLdutVZv/cUonwBD/6eDlE0aSiKK/uoH3+J1wDE/jMVqY2ysGufN84oIXB0sPzy8ollX/LegY74DgJXJR57sn+VGza0x3DnuIgABFM15LmajjjsNlYj+JEZGbuRYcAMOWxFkPN2w6Wd46xo4gVWQR/X4lyI/R6K/YK0110GzudPRW7Y+UOBGTfNNzHeYT0fiH0taunBpq9HEW8OKSaBGj21L0MqenEmNRWBAWDWAk4CpNoEZJ2tTaPFgbQYj8HxtFilErs3BTRwT8uO1NXQaWfIotchmPkAF5mMBAliEmZiOGVgCG9LgRzpscMAOOwowlT3JhusdazXGSC/hxR3UlmWVwWHpOIKheqONvjyhSiTHIkVUco5bnji8m//zL7PKaT1Vl5I6UE609f+gkr6MZKVyKc7zJRmCahLsdlyA5fdQkRSan9LgnnLEyGSkaKJCJog0wAgvepWBt80+1yKln1bMVtCljfNWDueKLsWwaEbBSfSPTEmVRsUcYYMnEjcjeyCZzBXK9E9BYBXLKjOSpUDR+nEV3TFSUdQaz+ot98QxgXwx0GQ+EEUAKB2qZPkQQ0GqFD8UPFMqyaCHM24BZmSGic9EYMagKizOw9Hz50DMrDLrqqLkTAhplMictiCAx5S3BIUQdeJeLnBy2CNtMfz6cV4u8XKoFZQesbf9YZiIERiHjaNodDW6LgcirX/mPnJIkBGDUpTBhSa0EIr38D5hCIszhCM8URGBqImoWjpvpt1ebu/v3Gl3qJfMnNM+9V+kiRFyROTPHQWOcs1dNW94/ukKMPZBvDi55i5CttdeJz84DLngLqjcdwEZ87bFFR8CIG35OAkDVN6VRDZ7aq67NteYqZ2lpT8oYB2CytoBd6VuAx4WgiAsnuj3WohG+LugzXiQRDeM3XYXlULv4dp5VFYC"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Size4-Regular.Dl5lxZxV.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Typewriter-Regular.CO6r4hn1.woff2"></head><body><div id="app" data-server-rendered="true"><!--[--><!--[--><div class="sakura-app-sidebar" data-v-0fb8bf6e><!----><aside class="left sakura-sidebar inset-y-0 overflow-y-auto transition" text="center" bg="contain no-repeat" data-v-0fb8bf6e><!--[--><div class="site-info flex flex-col items-center" data-v-0fb8bf6e><a href="/about" class="site-author-avatar"><img class="rounded-full" src="https://valaxy.site/valaxy-logo.png" alt="avatar"><span class="site-author-status" title="The moonlight is beautiful.">🌌</span></a><div class="site-author-name leading-6" m="t-0 b-4"><a href="/about" class>whisper3zzz</a></div><a href="/about/site" class="site-name">whisper3zzzの小窝</a><h4 class="site-subtitle block" text="xs">Next Generation Static Blog Framework.</h4><div class="site-description my-1">whisper3zzzの小窝</div></div><div class="links-of-author" data-v-0fb8bf6e data-v-3450e641><!--[--><a class="sakura-icon-btn links-of-author-item" rel="noopener" href="https://github.com/whisper3zzz" title="GitHub" target="_blank" style="color:#6e5494" data-v-3450e641><div class="i-ri-github-line icon" data-v-3450e641></div></a><a class="sakura-icon-btn links-of-author-item" rel="noopener" href="https://music.163.com/#/user/home?id=247102977" title="网易云音乐" target="_blank" style="color:#c20c0c" data-v-3450e641><div class="i-ri-netease-cloud-music-line icon" data-v-3450e641></div></a><a class="sakura-icon-btn links-of-author-item" rel="noopener" href="https://space.bilibili.com/1579790" title="哔哩哔哩" target="_blank" style="color:#ff8eb3" data-v-3450e641><div class="i-ri-bilibili-line icon" data-v-3450e641></div></a><a class="sakura-icon-btn links-of-author-item" rel="noopener" href="mailto:whisper3zzz@qq.com" title="E-Mail" target="_blank" style="color:#8e71c1" data-v-3450e641><div class="i-ri-mail-line icon" data-v-3450e641></div></a><!--]--></div><nav class="sakura-sidebar-link mt-4" data-v-0fb8bf6e data-v-0bc3e539><ul class="sakura-sidebar-link-items mx-auto" data-v-0bc3e539 data-v-c8f18fb2><!--[--><li data-v-c8f18fb2><a href="/" class="va-link sakura-nav-link sakura-sidebar-link-item sakura-nav-link sakura-sidebar-link-item" title="Home" rel="noopener" data-v-c8f18fb2 data-v-9e758860><!--[--><span class="i-ri-home-line hvr-icon sakura-icon sakura-nav-link-icon mr-0.5" inline-flex data-v-9e758860></span><span truncate class="sakura-nav-link-text <lg:hidden" data-v-9e758860>Home</span><!--[--><!----><!--]--><!--]--></a><!----></li><li data-v-c8f18fb2><a href="/categories" class="va-link sakura-nav-link sakura-sidebar-link-item sakura-nav-link sakura-sidebar-link-item" title="Categories" rel="noopener" data-v-c8f18fb2 data-v-9e758860><!--[--><span class="i-ri-folder-2-line hvr-icon sakura-icon sakura-nav-link-icon mr-0.5" inline-flex data-v-9e758860></span><span truncate class="sakura-nav-link-text <lg:hidden" data-v-9e758860>Categories</span><!--[--><!----><!--]--><!--]--></a><!----></li><li data-v-c8f18fb2><a href="/archives" class="va-link sakura-nav-link sakura-sidebar-link-item sakura-nav-link sakura-sidebar-link-item" title="Archives" rel="noopener" data-v-c8f18fb2 data-v-9e758860><!--[--><span class="i-ri-archive-line hvr-icon sakura-icon sakura-nav-link-icon mr-0.5" inline-flex data-v-9e758860></span><span truncate class="sakura-nav-link-text <lg:hidden" data-v-9e758860>Archives</span><!--[--><!----><!--]--><!--]--></a><!----></li><li data-v-c8f18fb2><a href="/tags" class="va-link sakura-nav-link sakura-sidebar-link-item sakura-nav-link sakura-sidebar-link-item" title="Tags" rel="noopener" data-v-c8f18fb2 data-v-9e758860><!--[--><span class="i-ri-price-tag-3-line hvr-icon sakura-icon sakura-nav-link-icon mr-0.5" inline-flex data-v-9e758860></span><span truncate class="sakura-nav-link-text <lg:hidden" data-v-9e758860>Tags</span><!--[--><!----><!--]--><!--]--></a><!----></li><li data-v-c8f18fb2><a href="/links" class="va-link sakura-nav-link sakura-sidebar-link-item sakura-nav-link sakura-sidebar-link-item" title="Links" rel="noopener" data-v-c8f18fb2 data-v-9e758860><!--[--><span class="i-fa-chain hvr-icon sakura-icon sakura-nav-link-icon mr-0.5" inline-flex data-v-9e758860></span><span truncate class="sakura-nav-link-text <lg:hidden" data-v-9e758860>Links</span><!--[--><!----><!--]--><!--]--></a><!----></li><!--]--></ul><div id="marker" data-v-0bc3e539></div></nav><!--]--><!--[--><div class="sakura-copyright copyright flex items-center justify-center" p="1" data-v-0fb8bf6e><span>Copyright © <span itemprop="copyrightYear"><!--[-->2023 -<!--]--> 2025</span></span><!----><!----><span itemprop="copyrightHolder">whisper3zzz</span></div><!--]--></aside></div><!--[--><!-- NOTE: Avoid placing sakura-sidebar-offset at the top; it affects absolute positioning --><div class="app-container custom-background antialiased has-post-layout" style data-v-73ded2f2><!--[--><!----><!--]--><!--[--><!--[--><!-- NOTE: Dynamic :class switching affects triggering the component loader for some reason, not sure why. --><header flex="~" w="full" fixed top-0 z-100 class="sakura-navbar sakura-sidebar-offset" data-v-73ded2f2><div flex="~ items-center justify-between" w="full" class="active-header no-animation sakura-safe-padding navbar-content"><!--[--><div flex="~ items-center"><div class="md:hidden flex-center"><!----><button class="mobile-btn mr-4" aria-label="mobile navigation" aria-expanded="false" data-v-2637eb86><!-- TODO: Add more color configurations? --><span class="bg-$sakura-color-action" data-v-2637eb86></span><span class="bg-$sakura-color-action" data-v-2637eb86></span><span class="bg-$sakura-color-action" data-v-2637eb86></span></button></div><div class="sakura-navbar-brand" data-v-648c0e72><!----><ruby class="navbar-title relative" data-v-648c0e72><a href="/" class="logo-link" aria-label="whisper3zzzの小窝" data-v-648c0e72><span data-v-648c0e72>whisper3zzzの小窝</span></a><!----></ruby></div></div><!--]--><!--[--><nav class="sakura-navbar-link sakura-preload fadeIn" data-v-9a8e7c84><!--[--><div class="sakura-dropdown sakura-navbar-link-item" aria-haspopup="true" aria-expanded="false" data-v-9a8e7c84 data-v-eeb1ce95 data-v-4c068fa2><!--[--><a href="/" class="va-link sakura-nav-link sakura-nav-link" title="Home" rel="noopener" data-v-eeb1ce95 data-v-9e758860><!--[--><span class="i-ri-home-line hvr-icon sakura-icon sakura-nav-link-icon mr-0.5" inline-flex data-v-9e758860></span><span truncate class="sakura-nav-link-text <lg:hidden" data-v-9e758860>Home</span><!--[--><!--]--><!--]--></a><!--]--><!----></div><div class="sakura-dropdown sakura-navbar-link-item" aria-haspopup="true" aria-expanded="false" data-v-9a8e7c84 data-v-eeb1ce95 data-v-4c068fa2><!--[--><a href="/categories" class="va-link sakura-nav-link sakura-nav-link" title="Categories" rel="noopener" data-v-eeb1ce95 data-v-9e758860><!--[--><span class="i-ri-folder-2-line hvr-icon sakura-icon sakura-nav-link-icon mr-0.5" inline-flex data-v-9e758860></span><span truncate class="sakura-nav-link-text <lg:hidden" data-v-9e758860>Categories</span><!--[--><!--]--><!--]--></a><!--]--><!----></div><div class="sakura-dropdown sakura-navbar-link-item" aria-haspopup="true" aria-expanded="false" data-v-9a8e7c84 data-v-eeb1ce95 data-v-4c068fa2><!--[--><a href="/archives" class="va-link sakura-nav-link sakura-nav-link" title="Archives" rel="noopener" data-v-eeb1ce95 data-v-9e758860><!--[--><span class="i-ri-archive-line hvr-icon sakura-icon sakura-nav-link-icon mr-0.5" inline-flex data-v-9e758860></span><span truncate class="sakura-nav-link-text <lg:hidden" data-v-9e758860>Archives</span><!--[--><!--]--><!--]--></a><!--]--><!----></div><div class="sakura-dropdown sakura-navbar-link-item" aria-haspopup="true" aria-expanded="false" data-v-9a8e7c84 data-v-eeb1ce95 data-v-4c068fa2><!--[--><a href="/tags" class="va-link sakura-nav-link sakura-nav-link" title="Tags" rel="noopener" data-v-eeb1ce95 data-v-9e758860><!--[--><span class="i-ri-price-tag-3-line hvr-icon sakura-icon sakura-nav-link-icon mr-0.5" inline-flex data-v-9e758860></span><span truncate class="sakura-nav-link-text <lg:hidden" data-v-9e758860>Tags</span><!--[--><!--]--><!--]--></a><!--]--><!----></div><div class="sakura-dropdown sakura-navbar-link-item" aria-haspopup="true" aria-expanded="false" data-v-9a8e7c84 data-v-eeb1ce95 data-v-4c068fa2><!--[--><a href="/links" class="va-link sakura-nav-link sakura-nav-link" title="Links" rel="noopener" data-v-eeb1ce95 data-v-9e758860><!--[--><span class="i-fa-chain hvr-icon sakura-icon sakura-nav-link-icon mr-0.5" inline-flex data-v-9e758860></span><span truncate class="sakura-nav-link-text <lg:hidden" data-v-9e758860>Links</span><!--[--><!--]--><!--]--></a><!--]--><!----></div><!--]--><div class="marker" data-v-9a8e7c84></div></nav><!--]--><!--[--><div h-full print:op0 flex="~ center" class="sakura-navbar-tools"><button class="sakura-icon-btn sakura-toggle-dark select-none" type="button" aria-label="Toggle Color Scheme"><div class="i-line-md-moon-alt-to-sunny-outline-loop-transition"></div></button><button class="sakura-icon-btn sakura-toggle-locale" title="切换语言"><div class="i-ri-translate transform transition"></div></button><div flex="center"><button class="sakura-icon-btn sakura-search-btn" title="搜索"><div i-mdi-search></div></button><!----></div><!----><!--[--><!--]--></div><!--]--></div></header><!--]--><!--]--><main class="sakura-sidebar-offset sakura-main" data-v-73ded2f2><!--[--><article class="sakura-page items-center sakura-post" flex="~ col"><!--[--><header class="sakura-page-header space-y-1 sakura-post-header" flex="~ center items-end justify-center" data-v-8dd1a56f><!----><div class="sakura-safe-padding sakura-header-container pb-25px" data-v-8dd1a56f><!--[--><div flex="~" class="sakura-header-title" data-v-8dd1a56f><div class="sakura-title sakura-braced-text flex-center" flex="~ items-center" data-v-8dd1a56f data-v-f4310435><!--[--><!----><!--]--><span data-v-f4310435>漫谈跨语言调用</span><!----></div></div><!--]--><!--[--><div class="sakura-post-header-meta text-$sakura-color-text" flex="~ wrap gap-x-4" py="1"><!-- TODO: 支持多作者 --><!-- <span class="inline-flex-center">
        <SakuraImageCard to="/about" class="mr-3px h-30px w-30px rounded-full" :src="siteConfig.author.avatar" alt="author image" />
        <span m="l-1">
          {{ siteConfig.author.name }}
        </span>
      </span> --><!-- TODO: 分类,标签 --><!-- <div class="inline-block" i-ri-calendar-line />
      <div i-ri-calendar-2-line /> --><div class="sakura-post-date posted-time post-time" data-v-3049e252><a aria-current="page" href="/posts/cross-language-call#" class="router-link-active router-link-exact-active va-link posted-time whitespace-nowrap align-top posted-time whitespace-nowrap align-top" flex="inline items-center" title="发表于2025-10-29" data-v-3049e252><!--[--><span i-mdi:clock-outline class="sakura-icon mr-1 inline-block" data-v-3049e252></span><span mr1 data-v-3049e252>发表于</span><dl class="inline-block" data-v-3049e252><dt class="sr-only">发表于</dt><dd>2025-10-29</dd></dl><!--]--></a></div><div class="sakura-post-date post-time edited-time" data-v-3049e252><a aria-current="page" href="/posts/cross-language-call#" class="router-link-active router-link-exact-active va-link posted-time whitespace-nowrap align-top posted-time whitespace-nowrap align-top" flex="inline items-center" title="更新于2025-12-18T13:11:53.303Z" data-v-3049e252><!--[--><span i-mdi:clock-outline class="sakura-icon mr-1 inline-block" data-v-3049e252></span><span mr1 data-v-3049e252>更新于</span><dl class="inline-block" data-v-3049e252><dt class="sr-only">更新于</dt><dd>2025-12-18</dd></dl><!--]--></a></div><!----><span class="inline-flex-center"><div i-ri-eye-line></div><span m="l-1">浏览量: -</span></span></div><!--]--></div></header><!--]--><!--[--><div class="sakura-triple-columns-base sakura-triple-columns"><aside><!--[--><!--]--></aside><div><!--[--><!-- This 'content' cannot be change. For more information, see https://github.com/YunYouJun/valaxy/blob/a7d24dfabb1022e20ec12bb1938fd272fd1e19e6/packages/valaxy/client/composables/outline/anchor.ts#L42 --><div class="content sakura-safe-padding sakura-page-content grid"><!--[--><!--[--><!--[--><!--[--><!--]--><!--[--><!--]--><!--[--><template><article class="markdown-body min-w-0"><!--[--><div class="max-w-none prose"><!--[--><!-- more --><p>C/C++、C#、Lua、JS/TS的跨语言调用</p><h2 id="引言-为什么需要跨语言调用" tabindex="-1">引言：为什么需要跨语言调用 <a class="header-anchor" href="#引言-为什么需要跨语言调用" aria-label="Permalink to &quot;引言：为什么需要跨语言调用&quot;">​</a></h2><h3 id="从游戏开发的角度出发" tabindex="-1">从游戏开发的角度出发 <a class="header-anchor" href="#从游戏开发的角度出发" aria-label="Permalink to &quot;从游戏开发的角度出发&quot;">​</a></h3><p>对于游戏开发而言，跨语言调用无论在提升开发效率还是降低成本方面，都是一剂良药。特别是在商业游戏开发中，将部分业务逻辑使用 Lua、JavaScript/TypeScript 等脚本语言实现，并交由外包团队编写，可以有效降低开发成本。同时，脚本语言的热更新特性使得开发团队能够快速修复线上的严重 Bug，无需重新发包，也无需等待 App Store 等应用商店的审核流程，从而显著提升玩家体验。</p><h3 id="编译型语言-vs-解释型语言" tabindex="-1">编译型语言 VS 解释型语言 <a class="header-anchor" href="#编译型语言-vs-解释型语言" aria-label="Permalink to &quot;编译型语言 VS 解释型语言&quot;">​</a></h3><p>从语言类型来看，C/C++ 属于编译型语言，通过编译器直接编译为汇编代码，最终生成机器码。而 Lua、JavaScript/TypeScript 等脚本语言则属于解释型语言，这类语言通过虚拟机（解释器）逐行解释执行代码。</p><p>C# 的实现方式则较为特殊：源代码首先由编译器编译为中间语言（IL），然后在运行时由 CLR（公共语言运行时）解释执行 IL 代码。</p><p>值得注意的是，"编译型语言"与"解释型语言"的划分更多是早期的习惯性称呼。现代的 Lua 早已采用了类似 C# 的实现方案——先将源代码编译为字节码（中间语言），再由虚拟机解释执行，从而在性能和灵活性之间取得平衡。</p><h3 id="托管代码与原生代码" tabindex="-1">托管代码与原生代码 <a class="header-anchor" href="#托管代码与原生代码" aria-label="Permalink to &quot;托管代码与原生代码&quot;">​</a></h3><p>理解跨语言调用的关键在于区分<strong>托管代码</strong>（Managed Code）与<strong>原生代码</strong>（Native Code）：</p><ul><li><p><strong>原生代码</strong>：如 C/C++ 编译后的机器码，直接在 CPU 上执行，拥有最高的性能和最底层的系统访问权限。开发者需要手动管理内存（malloc/free、new/delete），对内存布局有完全的控制权。</p></li><li><p><strong>托管代码</strong>：如 C#、Java、Lua 等语言的代码，运行在虚拟机之上。虚拟机提供了自动内存管理（垃圾回收）、类型安全检查、异常处理等高级特性，降低了开发难度，但也引入了一定的性能开销。</p></li></ul><p>跨语言调用的本质，就是在这两种不同的执行环境之间建立桥梁，使它们能够相互通信和协作。</p><h2 id="一、必备基础知识" tabindex="-1">一、必备基础知识 <a class="header-anchor" href="#一、必备基础知识" aria-label="Permalink to &quot;一、必备基础知识&quot;">​</a></h2><p>在深入跨语言调用的具体实现之前，需要掌握一些计算机底层的基础知识。这些知识将帮助我们理解不同语言之间是如何"对话"的。</p><h3 id="_1-1-计算机基础-函数调用的底层机制" tabindex="-1">1.1 计算机基础：函数调用的底层机制 <a class="header-anchor" href="#_1-1-计算机基础-函数调用的底层机制" aria-label="Permalink to &quot;1.1 计算机基础：函数调用的底层机制&quot;">​</a></h3><h4 id="cpu、内存与寄存器" tabindex="-1">CPU、内存与寄存器 <a class="header-anchor" href="#cpu、内存与寄存器" aria-label="Permalink to &quot;CPU、内存与寄存器&quot;">​</a></h4><p>当程序运行时，代码和数据都存储在内存中。CPU 通过寄存器（Register）来暂存计算过程中的数据。寄存器是 CPU 内部速度最快的存储单元，常见的寄存器包括：</p><ul><li><strong>通用寄存器</strong>：如<code>eax</code>、<code>ebx</code>、<code>ecx</code>、<code>edx</code> 等，用于存储临时数据和计算结果</li><li><strong>栈指针寄存器</strong>（<code>esp</code>）：指向当前栈顶位置</li><li><strong>基址指针寄存器</strong>（<code>ebp</code>）：指向当前函数栈帧的基址</li><li><strong>指令指针寄存器</strong>（<code>eip</code>）：指向下一条要执行的指令地址</li></ul><h4 id="函数调用栈与栈帧" tabindex="-1">函数调用栈与栈帧 <a class="header-anchor" href="#函数调用栈与栈帧" aria-label="Permalink to &quot;函数调用栈与栈帧&quot;">​</a></h4><p>函数调用的核心机制是<strong>调用栈</strong>（Call Stack）。每当调用一个函数时，系统会在栈上分配一块内存区域，称为<strong>栈帧</strong>（Stack Frame），用于存储：</p><ol><li><strong>函数参数</strong>：传递给函数的参数值</li><li><strong>返回地址</strong>：函数执行完毕后应该返回到哪里继续执行</li><li><strong>局部变量</strong>：函数内部定义的变量</li><li><strong>保存的寄存器值</strong>：调用前需要保存的寄存器状态</li></ol><p>函数调用的基本流程：</p><div class="language-"><button title="Copy code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span>1. 调用者将参数压入栈（或放入寄存器）</span></span>
<span class="line"><span>2. 调用者执行 CALL 指令，将返回地址压栈，跳转到被调用函数</span></span>
<span class="line"><span>3. 被调用函数保存旧的 ebp，设置新的栈帧</span></span>
<span class="line"><span>4. 被调用函数执行函数体</span></span>
<span class="line"><span>5. 被调用函数将返回值放入约定的位置（通常是 eax 寄存器）</span></span>
<span class="line"><span>6. 被调用函数恢复栈帧，执行 RET 指令返回</span></span>
<span class="line"><span>7. 调用者从约定位置获取返回值，继续执行</span></span></code></pre><button class="code-block-unfold-btn"></button></div><h4 id="地址空间与指针" tabindex="-1">地址空间与指针 <a class="header-anchor" href="#地址空间与指针" aria-label="Permalink to &quot;地址空间与指针&quot;">​</a></h4><p>每个进程都有自己独立的虚拟地址空间，通常分为几个区域：</p><ul><li><strong>代码段</strong>（Text Segment）：存储程序的机器码指令，通常是只读的</li><li><strong>数据段</strong>（Data Segment）：存储全局变量和静态变量</li><li><strong>堆</strong>（Heap）：动态分配的内存区域，由程序员手动管理（C/C++）或由垃圾回收器管理（脚本语言）</li><li><strong>栈</strong>（Stack）：存储函数调用栈帧，自动管理，大小有限</li></ul><p><strong>指针</strong>是存储内存地址的变量。在跨语言调用中，指针是传递复杂数据结构的关键手段。例如，C 函数可能返回一个指向结构体的指针，脚本语言需要正确解释这个地址并访问其中的数据。</p><h3 id="_1-2-语言运行时与虚拟机" tabindex="-1">1.2 语言运行时与虚拟机 <a class="header-anchor" href="#_1-2-语言运行时与虚拟机" aria-label="Permalink to &quot;1.2 语言运行时与虚拟机&quot;">​</a></h3><h4 id="虚拟机的概念" tabindex="-1">虚拟机的概念 <a class="header-anchor" href="#虚拟机的概念" aria-label="Permalink to &quot;虚拟机的概念&quot;">​</a></h4><p>虚拟机（Virtual Machine）是一个软件层，模拟了一个抽象的计算机环境。常见的虚拟机包括：</p><ul><li><strong>Lua VM</strong>：基于寄存器的虚拟机，执行 Lua 字节码</li><li><strong>CLR</strong>（Common Language Runtime）：.NET 的运行时，执行 IL（中间语言）</li><li><strong>V8</strong>：Google 的 JavaScript 引擎，使用 JIT（即时编译）技术将 JavaScript 编译为机器码</li></ul><p>虚拟机提供了：</p><ol><li><strong>字节码解释执行</strong>：将中间语言翻译为机器指令</li><li><strong>内存管理</strong>：自动分配和回收内存</li><li><strong>类型系统</strong>：运行时类型检查和转换</li><li><strong>异常处理</strong>：统一的错误处理机制</li></ol><h4 id="垃圾回收-garbage-collection" tabindex="-1">垃圾回收（Garbage Collection） <a class="header-anchor" href="#垃圾回收-garbage-collection" aria-label="Permalink to &quot;垃圾回收（Garbage Collection）&quot;">​</a></h4><p>垃圾回收器（GC）自动管理内存，回收不再使用的对象。常见的 GC 算法包括：</p><ul><li><strong>引用计数</strong>（Reference Counting）：Lua 5.0 之前使用，简单但无法处理循环引用</li><li><strong>标记-清除</strong>（Mark-Sweep）：Lua 5.1+ 使用，分为标记阶段和清除阶段</li><li><strong>分代回收</strong>（Generational GC）：.NET、V8 使用，基于"大部分对象都很快死亡"的假设</li><li><strong>增量回收</strong>（Incremental GC）：将 GC 工作分散到多个时间片，减少停顿</li></ul><p><strong>跨语言调用中的 GC 问题</strong>：</p><ul><li>原生代码持有托管对象的指针时，必须防止对象被 GC 回收</li><li>托管代码持有原生内存时，需要在对象被回收时释放原生内存（使用 finalizer 或析构函数）</li></ul><h4 id="类型系统-静态类型-vs-动态类型" tabindex="-1">类型系统：静态类型 vs 动态类型 <a class="header-anchor" href="#类型系统-静态类型-vs-动态类型" aria-label="Permalink to &quot;类型系统：静态类型 vs 动态类型&quot;">​</a></h4><ul><li><strong>静态类型语言</strong>（C/C++、C#、Java）：编译时确定变量类型，类型错误在编译期发现，性能更高</li><li><strong>动态类型语言</strong>（Lua、JavaScript）：运行时确定变量类型，更灵活但性能较低</li></ul><p>跨语言调用时，需要在两种类型系统之间进行转换：</p><ul><li>C 的 <code>int</code> 对应 Lua 的 <code>number</code></li><li>C 的 <code>char*</code> 对应 Lua 的 <code>string</code></li><li>C 的结构体指针对应 Lua 的 <code>userdata</code></li></ul><p>这种转换通常由语言的 FFI 层自动完成，但开发者需要理解其中的映射关系和潜在的性能开销。</p><h2 id="二、核心概念" tabindex="-1">二、核心概念 <a class="header-anchor" href="#二、核心概念" aria-label="Permalink to &quot;二、核心概念&quot;">​</a></h2><h3 id="_2-1-abi-application-binary-interface" tabindex="-1">2.1 ABI（Application Binary Interface） <a class="header-anchor" href="#_2-1-abi-application-binary-interface" aria-label="Permalink to &quot;2.1 ABI（Application Binary Interface）&quot;">​</a></h3><p>ABI 定义了二进制层面的接口规范，包括：</p><ul><li>数据类型的大小和对齐方式</li><li>函数调用约定</li><li>系统调用接口</li><li>目标文件格式（如 ELF、PE）</li></ul><p>不同编译器、不同编译选项可能产生不兼容的 ABI。跨语言调用时，必须确保双方遵循相同的 ABI 规范。</p><h3 id="_2-2-为什么-c-c-是跨语言调用的通用桥梁" tabindex="-1">2.2 为什么 C/C++ 是跨语言调用的通用桥梁 <a class="header-anchor" href="#_2-2-为什么-c-c-是跨语言调用的通用桥梁" aria-label="Permalink to &quot;2.2 为什么 C/C++ 是跨语言调用的通用桥梁&quot;">​</a></h3><p>几乎所有语言之间的互调，本质上都要经过 C/C++ 层作为“中间桥梁”。</p><h4 id="c-abi-为事实上的-通用二进制接口标准" tabindex="-1">C ABI 为事实上的“通用二进制接口标准” <a class="header-anchor" href="#c-abi-为事实上的-通用二进制接口标准" aria-label="Permalink to &quot;C ABI 为事实上的“通用二进制接口标准”&quot;">​</a></h4><ul><li>操作系统 API 面向 C：Windows API、POSIX 接口都以 C 函数与结构体定义为主。</li><li>绝大多数 FFI（Foreign Function Interface，外部函数接口）都围绕 C 的 ABI（Application Binary Interface，应用二进制接口）建立。</li><li>动态库边界以 C 为准：dlopen/LoadLibrary 加载的函数符号，默认遵循 C 调用约定与命名规则（配合 extern "C"）。</li><li>C 语义最小、公约数最大：无对象模型、无隐藏 vtable、无异常传播约定，跨编译器/跨平台最稳定。</li><li>C++ 的ABI 不稳定：不同编译器与平台的 name mangling、对象布局、异常约定差异较大，跨边界需要显式 C 包装。</li><li>几乎所有语言与运行时（CLR、JVM、V8、Lua VM、CPython）都对外提供 C/C++ 接口。</li></ul><h4 id="跨语言调用的底层机制" tabindex="-1">跨语言调用的底层机制 <a class="header-anchor" href="#跨语言调用的底层机制" aria-label="Permalink to &quot;跨语言调用的底层机制&quot;">​</a></h4><ul><li>C# ↔ C/C++：<ul><li>P/Invoke、C++/CLI、Native Plugin</li><li>本质上通过 C ABI 调用导出的函数符号，CLR 负责参数封送</li></ul></li><li>Lua ↔ C/C++：<ul><li>Lua C API、LuaJIT FFI</li><li>本质上以 lua_State* 为中枢，栈上传参、取回结果</li></ul></li><li>JavaScript/TypeScript ↔ C/C++：<ul><li>V8 原生 API（Embedding）、QuickJS 原生 API</li><li>本质上引擎提供 C/C++ 接口管理 JS 对象与执行环境</li></ul></li></ul><h4 id="示例-同一个-c-函数被多语言调用" tabindex="-1">示例：同一个 C 函数被多语言调用 <a class="header-anchor" href="#示例-同一个-c-函数被多语言调用" aria-label="Permalink to &quot;示例：同一个 C 函数被多语言调用&quot;">​</a></h4><div class="language-c"><button title="Copy code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// addlib.c</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> b;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><ul><li>在 C++ 中调用（使用 C 接口规避 name mangling）：</li></ul><div class="language-cpp"><button title="Copy code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">extern</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "C"</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><ul><li>在 C# 中调用（P/Invoke）：</li></ul><div class="language-csharp"><button title="Copy code" class="copy"></button><span class="lang">csharp</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">using</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> System</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">Runtime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">InteropServices</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Native</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    [</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">DllImport</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"addlib"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">CallingConvention</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> CallingConvention.Cdecl)]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> extern</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><ul><li>在 Lua（LuaJIT）中调用（FFI）：</li></ul><div class="language-lua"><button title="Copy code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ffi </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"ffi"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">ffi.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">cdef</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">[[</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">); </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">]]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> lib </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ffi.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">load</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"./addlib.so"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">-- Windows 下可为 addlib.dll</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(lib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">))</span></span></code></pre><button class="code-block-unfold-btn"></button></div><p>这些示例都在调用同一个 C 函数。唯一要求是各语言侧的 FFI 层遵循相同的 C ABI。</p><h3 id="_2-3-ffi-foreign-function-interface-深入解析" tabindex="-1">2.3 FFI（Foreign Function Interface）深入解析 <a class="header-anchor" href="#_2-3-ffi-foreign-function-interface-深入解析" aria-label="Permalink to &quot;2.3 FFI（Foreign Function Interface）深入解析&quot;">​</a></h3><h4 id="ffi-的定义和作用" tabindex="-1">FFI 的定义和作用 <a class="header-anchor" href="#ffi-的定义和作用" aria-label="Permalink to &quot;FFI 的定义和作用&quot;">​</a></h4><p><strong>FFI</strong>（Foreign Function Interface，外部函数接口）是一种机制，允许一种编程语言调用另一种语言编写的函数。在实践中，FFI 通常特指高级语言调用 C 语言函数的接口，因为：</p><ol><li><strong>C 语言的通用性</strong>：C 是最接近硬件的高级语言，几乎所有操作系统 API 都提供 C 接口</li><li><strong>ABI 稳定性</strong>：C 的 ABI 相对简单且稳定，易于跨编译器和平台兼容</li><li><strong>最小公约数</strong>：C 可以作为不同语言之间的"通用语言"</li></ol><p>FFI 的核心作用是<strong>解决类型系统和调用约定的差异</strong>，使得运行在虚拟机上的托管代码能够安全、正确地调用原生代码。</p><h4 id="ffi-的工作原理" tabindex="-1">FFI 的工作原理 <a class="header-anchor" href="#ffi-的工作原理" aria-label="Permalink to &quot;FFI 的工作原理&quot;">​</a></h4><p>FFI 的工作流程可以分为以下几个步骤：</p><p><strong>1. 类型映射（Type Mapping）</strong></p><p>FFI 需要在两种语言的类型系统之间建立映射关系。例如，Lua 调用 C 函数时：</p><div class="language-"><button title="Copy code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span>Lua 类型          →    C 类型</span></span>
<span class="line"><span>-----------------------------------------</span></span>
<span class="line"><span>number           →    int / double / float</span></span>
<span class="line"><span>string           →    const char*</span></span>
<span class="line"><span>boolean          →    int (0/1)</span></span>
<span class="line"><span>table            →    结构体指针 / 数组指针</span></span>
<span class="line"><span>function         →    函数指针</span></span>
<span class="line"><span>userdata         →    void* (任意 C 对象)</span></span>
<span class="line"><span>nil              →    NULL</span></span></code></pre><button class="code-block-unfold-btn"></button></div><p><strong>2. 参数封送（Marshalling）</strong></p><p>在调用发生前，FFI 需要将高级语言的数据转换为 C 能够理解的格式：</p><ul><li>将 Lua 的字符串转换为 C 的 <code>char*</code> 指针</li><li>将 Lua 的 table 转换为 C 的结构体</li><li>处理内存对齐和字节序问题</li></ul><p><strong>3. 调用约定适配</strong></p><p>FFI 必须按照正确的调用约定来调用 C 函数：</p><ul><li>将参数放入正确的寄存器或栈位置</li><li>保存和恢复必要的寄存器</li><li>正确处理返回值</li></ul><p><strong>4. 结果解封（Unmarshalling）</strong></p><p>调用完成后，FFI 将 C 函数的返回值转换回高级语言的类型：</p><ul><li>将 C 的 <code>char*</code> 转换为 Lua 的字符串（可能需要复制内存）</li><li>将 C 的结构体指针包装为 Lua 的 userdata</li><li>处理错误和异常</li></ul><h4 id="跨语言调用的底层机制详解" tabindex="-1">跨语言调用的底层机制详解 <a class="header-anchor" href="#跨语言调用的底层机制详解" aria-label="Permalink to &quot;跨语言调用的底层机制详解&quot;">​</a></h4><p>让我们通过一个具体的例子来理解 FFI 的底层机制。假设 Lua 调用以下 C 函数：</p><div class="language-c"><button title="Copy code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// C 代码</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> b;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><p>在 Lua 中调用：</p><div class="language-lua"><button title="Copy code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">-- Lua 代码</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span></span></code></pre><button class="code-block-unfold-btn"></button></div><p>底层发生的事情：</p><ol><li><p><strong>Lua 解释器识别函数调用</strong>：Lua VM 发现 <code>add</code> 是一个 C 函数（通过元表或注册表）</p></li><li><p><strong>参数准备</strong>：</p><ul><li>Lua VM 从栈上取出两个参数（10 和 20）</li><li>检查类型是否为 number</li><li>将 Lua number（通常是 double）转换为 C int</li></ul></li><li><p><strong>调用 C 函数</strong>：</p><ul><li>按照 C 调用约定（如 cdecl 或 x64 calling convention）将参数放入寄存器或栈</li><li>执行 CALL 指令跳转到 C 函数地址</li><li>C 函数执行，将结果放入 rax 寄存器（x64）或栈上</li></ul></li><li><p><strong>返回值处理</strong>：</p><ul><li>Lua VM 从约定的位置获取返回值</li><li>将 C int 转换为 Lua number</li><li>将结果压入 Lua 栈</li></ul></li><li><p><strong>继续执行</strong>：Lua VM 继续执行后续的 Lua 代码</p></li></ol><h3 id="_2-4-动态库与静态库" tabindex="-1">2.4 动态库与静态库 <a class="header-anchor" href="#_2-4-动态库与静态库" aria-label="Permalink to &quot;2.4 动态库与静态库&quot;">​</a></h3><h4 id="为什么跨语言调用必须使用动态库" tabindex="-1">为什么跨语言调用必须使用动态库 <a class="header-anchor" href="#为什么跨语言调用必须使用动态库" aria-label="Permalink to &quot;为什么跨语言调用必须使用动态库&quot;">​</a></h4><p>跨语言调用几乎总是依赖<strong>动态链接库</strong>（Dynamic Link Library），原因如下：</p><p><strong>1. 运行时加载的需求</strong></p><p>脚本语言通常在运行时才决定要调用哪些原生函数。动态库可以在程序运行时通过 <code>dlopen</code>（Linux）或 <code>LoadLibrary</code>（Windows）动态加载，而静态库必须在编译时链接。</p><p><strong>2. 代码共享</strong></p><p>多个脚本虚拟机实例可以共享同一个动态库的代码段，节省内存。例如，多个 Lua 虚拟机可以共享同一个 C 扩展库。</p><p><strong>3. 独立更新</strong></p><p>动态库可以独立于脚本引擎进行更新。修复 C 库的 Bug 时，只需替换 <code>.so</code> 或 <code>.dll</code> 文件，无需重新编译整个应用。</p><p><strong>4. 语言无关性</strong></p><p>动态库提供了标准的 C ABI 接口，任何支持 FFI 的语言都可以调用，实现了真正的语言无关性。</p><h4 id="静态库为什么不适用于跨语言调用" tabindex="-1">静态库为什么不适用于跨语言调用 <a class="header-anchor" href="#静态库为什么不适用于跨语言调用" aria-label="Permalink to &quot;静态库为什么不适用于跨语言调用&quot;">​</a></h4><p>静态库（<code>.a</code> 或 <code>.lib</code>）在编译时被链接到可执行文件中，存在以下问题：</p><p><strong>1. 无法运行时加载</strong></p><p>静态库的代码在编译时就被合并到可执行文件中，脚本语言无法在运行时动态加载静态库中的函数。</p><p><strong>2. 符号冲突</strong></p><p>如果多个静态库包含同名符号，链接时会产生冲突。动态库通过符号隔离机制（如命名空间、符号版本）可以避免这个问题。</p><p><strong>3. 内存浪费</strong></p><p>每个使用静态库的程序都会包含一份库代码的副本，造成磁盘和内存浪费。</p><p><strong>4. 缺乏 ABI 稳定性</strong></p><p>静态库的内部实现细节（如 C++ 的 name mangling）会暴露给链接器，不同编译器编译的静态库可能无法链接在一起。</p><h4 id="动态库的符号导出和加载机制" tabindex="-1">动态库的符号导出和加载机制 <a class="header-anchor" href="#动态库的符号导出和加载机制" aria-label="Permalink to &quot;动态库的符号导出和加载机制&quot;">​</a></h4><p><strong>符号导出（Symbol Export）</strong></p><p>在 C/C++ 中，需要显式标记哪些函数可以被外部调用：</p><div class="language-c"><button title="Copy code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// Windows (MSVC)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">__declspec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(dllexport) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// Linux/macOS (GCC/Clang)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">__attribute__</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">((</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">visibility</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"default"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">))) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// 跨平台宏定义</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">#ifdef</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> _WIN32</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    #define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> EXPORT</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> __declspec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(dllexport)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">#else</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    #define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> EXPORT</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> __attribute__</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">((</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">visibility</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"default"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">#endif</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">EXPORT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> b;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><p><strong>符号加载（Symbol Loading）</strong></p><p>脚本语言通过 FFI 加载动态库并获取函数地址：</p><div class="language-lua"><button title="Copy code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">-- LuaJIT FFI 示例</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ffi </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"ffi"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">-- 声明 C 函数签名</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">ffi.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">cdef</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">[[</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">]]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">-- 加载动态库</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> mylib </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ffi.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">load</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"mylib"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">-- 自动查找 mylib.so 或 mylib.dll</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">-- 调用 C 函数</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> mylib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(result)  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">-- 输出 30</span></span></code></pre><button class="code-block-unfold-btn"></button></div><h4 id="示例" tabindex="-1">示例 <a class="header-anchor" href="#示例" aria-label="Permalink to &quot;示例&quot;">​</a></h4><p>假设我们使用 C++ 编写了一个高性能的物理引擎，需要在 Lua 脚本中调用：</p><ol><li><p><strong>编译为动态库</strong></p></li><li><p><strong>导出 C 接口</strong>：</p><div class="language-cpp"><button title="Copy code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// physics.h</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">extern</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "C"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    EXPORT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">void*</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> CreateRigidBody</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">float</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> mass);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    EXPORT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> ApplyForce</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">void*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> body, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">float</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> x, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">float</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> y, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">float</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> z);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    EXPORT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> DestroyRigidBody</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">void*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> body);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div></li><li><p><strong>Lua 中调用</strong>：</p><div class="language-lua"><button title="Copy code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ffi </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"ffi"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">ffi.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">cdef</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">[[</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    void*</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> CreateRigidBody</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">float</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> mass</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> ApplyForce</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">void*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> body</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">float</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> x</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">float</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> y</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">float</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> z</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> DestroyRigidBody</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">void*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> body</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">]]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> physics </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ffi.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">load</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"physics"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">-- 创建刚体</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> body </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> physics.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">CreateRigidBody</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">10.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">-- 施加力</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">physics.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">ApplyForce</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(body, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">-- 销毁刚体</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">physics.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">DestroyRigidBody</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(body)</span></span></code></pre><button class="code-block-unfold-btn"></button></div></li></ol><p>这种方式使得性能关键的物理计算在 C++ 中执行，而游戏逻辑在 Lua 中编写，兼顾了性能和开发效率。</p><h3 id="_2-5-语言绑定-binding" tabindex="-1">2.5 语言绑定（Binding） <a class="header-anchor" href="#_2-5-语言绑定-binding" aria-label="Permalink to &quot;2.5 语言绑定（Binding）&quot;">​</a></h3><h4 id="什么是语言绑定及其必要性" tabindex="-1">什么是语言绑定及其必要性 <a class="header-anchor" href="#什么是语言绑定及其必要性" aria-label="Permalink to &quot;什么是语言绑定及其必要性&quot;">​</a></h4><p><strong>语言绑定</strong>（Language Binding）是指为原生代码（通常是 C/C++）创建一层包装代码，使其能够被脚本语言调用。绑定层的主要职责包括：</p><ol><li><strong>类型转换</strong>：在脚本类型和 C 类型之间进行转换</li><li><strong>对象生命周期管理</strong>：管理 C++ 对象的创建和销毁</li><li><strong>异常处理</strong>：将 C++ 异常转换为脚本语言的错误机制</li><li><strong>API 适配</strong>：将面向对象的 C++ API 转换为脚本友好的接口</li></ol><p><strong>为什么需要绑定？</strong></p><p>虽然 FFI 可以直接调用 C 函数，但对于复杂的 C++ API（类、继承、模板、重载等），直接调用非常困难：</p><ul><li>C++ 的 name mangling 使得函数名不可预测</li><li>C++ 的对象模型（虚函数表、多重继承）与脚本语言不兼容</li><li>C++ 的 RAII 和异常机制需要特殊处理</li></ul><p>绑定层将 C++ 的复杂性隐藏起来，提供简洁的 C 接口或脚本友好的 API。</p><h4 id="手写绑定的方法和优缺点" tabindex="-1">手写绑定的方法和优缺点 <a class="header-anchor" href="#手写绑定的方法和优缺点" aria-label="Permalink to &quot;手写绑定的方法和优缺点&quot;">​</a></h4><p><strong>手写绑定示例</strong>（Lua C API）：</p><p>假设有以下 C++ 类：</p><div class="language-cpp"><button title="Copy code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// Player.h</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Player</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">public:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    Player</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> std</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">string</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> SetHealth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> health</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> GetHealth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Attack</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">Player</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> target</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> damage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">private:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    std</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">::string name_;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> health_;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">};</span></span></code></pre><button class="code-block-unfold-btn"></button></div><p>手写 Lua 绑定：</p><div class="language-cpp"><button title="Copy code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// player_binding.cpp</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> &lt;lua.hpp&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "Player.h"</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// 创建 Player 对象</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> lua_Player_new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">lua_State</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> L</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> char*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> luaL_checkstring</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(L, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    // 在 Lua 管理的内存中创建 Player 对象</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    Player</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> udata </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (Player</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">lua_newuserdata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(L, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(Player</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">udata </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Player</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(name);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    // 设置元表</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    luaL_getmetatable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(L, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"Player"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    lua_setmetatable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(L, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  // 返回 userdata</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// 设置生命值</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> lua_Player_SetHealth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">lua_State</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> L</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    Player</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> udata </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (Player</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">luaL_checkudata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(L, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"Player"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> health </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> luaL_checkinteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(L, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">udata)-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">SetHealth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(health);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// 获取生命值</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> lua_Player_GetHealth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">lua_State</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> L</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    Player</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> udata </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (Player</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">luaL_checkudata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(L, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"Player"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> health </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">udata)-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">GetHealth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    lua_pushinteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(L, health);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// 攻击</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> lua_Player_Attack</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">lua_State</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> L</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    Player</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> self </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (Player</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">luaL_checkudata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(L, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"Player"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    Player</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> target </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (Player</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">luaL_checkudata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(L, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"Player"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> damage </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> luaL_checkinteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(L, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">self)-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">Attack</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">target, damage);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// 垃圾回收</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> lua_Player_gc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">lua_State</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> L</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    Player</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> udata </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (Player</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">luaL_checkudata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(L, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"Player"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    delete</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">udata;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// 注册到 Lua</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> luaopen_player</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">lua_State</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> L</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    // 创建元表</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    luaL_newmetatable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(L, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"Player"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    // 设置 __gc 元方法</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    lua_pushcfunction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(L, lua_Player_gc);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    lua_setfield</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(L, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"__gc"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    // 设置 __index 为自身（方法查找）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    lua_pushvalue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(L, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    lua_setfield</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(L, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"__index"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    // 注册方法</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    luaL_Reg methods[] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        {</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"SetHealth"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, lua_Player_SetHealth},</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        {</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"GetHealth"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, lua_Player_GetHealth},</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        {</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"Attack"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, lua_Player_Attack},</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        {</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    };</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    luaL_setfuncs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(L, methods, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    // 注册构造函数</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    lua_newtable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(L);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    lua_pushcfunction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(L, lua_Player_new);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    lua_setfield</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(L, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"new"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><p>在 Lua 中使用：</p><div class="language-lua"><button title="Copy code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Player </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"player"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> player1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Player.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"Alice"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> player2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Player.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"Bob"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">player1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">SetHealth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">player2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">SetHealth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">player1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">Attack</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(player2, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">player2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">GetHealth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">())  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">-- 输出 80</span></span></code></pre><button class="code-block-unfold-btn"></button></div><h4 id="unity-引擎中的-c-↔-c-类型绑定" tabindex="-1">Unity 引擎中的 C# ↔ C++ 类型绑定 <a class="header-anchor" href="#unity-引擎中的-c-↔-c-类型绑定" aria-label="Permalink to &quot;Unity 引擎中的 C# ↔ C++ 类型绑定&quot;">​</a></h4><p>Unity 引擎是跨语言调用的典型应用场景：引擎核心使用 C++ 编写以保证性能，而脚本层使用 C# 提供易用的开发体验。这种架构本质上是 <strong>托管代码（C#）与原生代码（C++）的双向互调</strong>。</p><h5 id="托管对象在原生代码中的表示" tabindex="-1">托管对象在原生代码中的表示 <a class="header-anchor" href="#托管对象在原生代码中的表示" aria-label="Permalink to &quot;托管对象在原生代码中的表示&quot;">​</a></h5><p>在 Unity 的实现中，C# 侧的所有对象都继承自 <code>System.Object</code>，由 .NET 的垃圾回收器（GC）管理内存。当这些托管对象需要传递到 C++ 层时，Unity 使用 <strong>Mono 运行时</strong>（或 IL2CPP）作为桥梁。</p><p>C++ 代码通过 <code>ScriptingObjectPtr</code> 类来持有托管对象的引用：</p><div class="language-cpp"><button title="Copy code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// Unity 引擎内部实现（简化版）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">typedef</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> MonoObject</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ScriptingBackendNativeObjectPtr;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> ScriptingObjectPtr</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">public:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    ScriptingObjectPtr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">ScriptingBackendNativeObjectPtr</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> target</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        : </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">m_Target</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(target) {}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">protected:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    ScriptingBackendNativeObjectPtr m_Target;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  // 指向 Mono 托管对象的指针</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">};</span></span></code></pre><button class="code-block-unfold-btn"></button></div><p><strong>关键点解析</strong>：</p><ol><li><p><strong><code>MonoObject*</code> 类型</strong>：这是 Mono 运行时提供的 C API 类型，表示一个托管对象的原生指针。通过这个指针，C++ 代码可以访问 C# 对象的数据。</p></li><li><p><strong>GC 安全性问题</strong>：<code>ScriptingBackendNativeObjectPtr</code> 是一个指向 GC 堆的"裸指针"。如果 C++ 代码长期持有这个指针，而 GC 移动或回收了对象，就会导致<strong>悬垂指针</strong>（Dangling Pointer）问题。</p></li><li><p><strong>GC Handle 机制</strong>：为了防止对象被 GC 回收，Unity 内部使用 <strong>GC Handle</strong>（垃圾回收句柄）来"钉住"（Pin）托管对象，确保其在原生代码使用期间不会被移动或回收：</p><div class="language-cpp"><button title="Copy code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// 创建 GC Handle，防止对象被回收</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">uint32_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> handle </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> mono_gchandle_new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(monoObject, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// 使用完毕后释放 Handle</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">mono_gchandle_free</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(handle);</span></span></code></pre><button class="code-block-unfold-btn"></button></div></li></ol><h5 id="双向引用的生命周期管理" tabindex="-1">双向引用的生命周期管理 <a class="header-anchor" href="#双向引用的生命周期管理" aria-label="Permalink to &quot;双向引用的生命周期管理&quot;">​</a></h5><p>Unity 中的对象通常同时存在于两个世界：</p><ul><li><strong>C# 侧</strong>：<code>GameObject</code>、<code>Component</code> 等托管对象</li><li><strong>C++ 侧</strong>：对应的原生对象（如渲染数据、物理碰撞体）</li></ul><p>这种双向引用带来了复杂的生命周期管理问题：</p><ul><li>当 C# 对象被销毁时（如调用 <code>Destroy()</code>），需要通知 C++ 侧释放原生资源</li><li>当原生对象被销毁时，需要将 C# 侧的引用置为 <code>null</code>，避免访问已释放的内存</li></ul><p>Unity 通过 <strong>InstanceID</strong> 机制和 <strong>对象生命周期回调</strong> 来协调两侧的同步，这是游戏引擎中跨语言调用的经典难题之一。</p><h4 id="自动生成绑定的工具和方案" tabindex="-1">自动生成绑定的工具和方案 <a class="header-anchor" href="#自动生成绑定的工具和方案" aria-label="Permalink to &quot;自动生成绑定的工具和方案&quot;">​</a></h4><p>为了解决手写绑定的问题，业界开发了多种自动绑定生成工具。</p><h5 id="swig-simplified-wrapper-and-interface-generator" tabindex="-1">SWIG（Simplified Wrapper and Interface Generator） <a class="header-anchor" href="#swig-simplified-wrapper-and-interface-generator" aria-label="Permalink to &quot;SWIG（Simplified Wrapper and Interface Generator）&quot;">​</a></h5><p><strong>SWIG</strong> 是最古老、最成熟的跨语言绑定生成工具，支持 40+ 种语言。</p><p><strong>工作原理</strong>：</p><ol><li>解析 C/C++ 头文件或 SWIG 接口文件（<code>.i</code>）</li><li>生成目标语言的绑定代码</li><li>编译生成的代码为动态库</li></ol><p><strong>示例</strong>（为 Lua 生成绑定）：</p><div class="language-swig"><button title="Copy code" class="copy"></button><span class="lang">swig</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span>// player.i</span></span>
<span class="line"><span>%module player</span></span>
<span class="line"><span></span></span>
<span class="line"><span>%{</span></span>
<span class="line"><span>#include "Player.h"</span></span>
<span class="line"><span>\%\}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>%include "Player.h"</span></span></code></pre><button class="code-block-unfold-btn"></button></div><p>生成绑定：</p><div class="language-bash"><button title="Copy code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">swig</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> -c++</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> -lua</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> player.i</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">g++</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> -shared</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> -fPIC</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> player_wrap.cxx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> Player.cpp</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> player.so</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> -llua</span></span></code></pre><button class="code-block-unfold-btn"></button></div><p>在 Lua 中使用：</p><div class="language-lua"><button title="Copy code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> player </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"player"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> p1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> player.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">Player</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"Alice"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">p1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">SetHealth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">p1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">GetHealth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">())</span></span></code></pre><button class="code-block-unfold-btn"></button></div><h5 id="puerts-unity-ue-javascript-typescript-绑定" tabindex="-1">Puerts（Unity/UE JavaScript/TypeScript 绑定） <a class="header-anchor" href="#puerts-unity-ue-javascript-typescript-绑定" aria-label="Permalink to &quot;Puerts（Unity/UE JavaScript/TypeScript 绑定）&quot;">​</a></h5><p><strong>Puerts</strong> 是腾讯开源的 Unity/UE JavaScript/TypeScript 解决方案，基于 V8/QuickJS 引擎。</p><p><strong>工作原理</strong>：</p><ol><li>使用 C# 反射或静态代码生成</li><li>自动为 C# 类生成 JavaScript 绑定</li><li>通过 V8 的 C++ API 桥接 C# 和 JavaScript</li></ol><p><strong>示例</strong>：</p><div class="language-csharp"><button title="Copy code" class="copy"></button><span class="lang">csharp</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// C# 代码（Unity）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Player</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> string</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> { </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">; }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Health</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> { </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">; }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Attack</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">Player</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> target</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> damage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        target.Health </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">-=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> damage;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><p>在 TypeScript 中使用（无需手写绑定）：</p><div class="language-typescript"><button title="Copy code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> { Player } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> 'csharp'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> player1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Player</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">player1.Name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "Alice"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">player1.Health </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> player2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Player</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">player2.Name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "Bob"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">player2.Health </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">player1.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">Attack</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(player2, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(player2.Health);  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// 输出 80</span></span></code></pre><button class="code-block-unfold-btn"></button></div><h4 id="类型映射的原理和实现" tabindex="-1">类型映射的原理和实现 <a class="header-anchor" href="#类型映射的原理和实现" aria-label="Permalink to &quot;类型映射的原理和实现&quot;">​</a></h4><p>类型映射是绑定层的核心任务之一。不同语言的类型系统差异很大，需要建立合理的映射关系。</p><p><strong>基本类型映射</strong>：不同语言之间需要建立类型对应关系，例如 C/C++ 的 <code>int</code> 对应 Lua 的 <code>number</code>、JavaScript 的 <code>number</code>、C# 的 <code>int</code>；C/C++ 的 <code>char*</code> 对应各语言的字符串类型；C/C++ 的 <code>void*</code> 对应 Lua 的 <code>userdata</code>、JavaScript 的 <code>ArrayBuffer</code>、C# 的 <code>IntPtr</code>。</p><p><strong>复杂类型映射</strong>：</p><ol><li><p><strong>数组</strong>：</p><ul><li>C: <code>int arr[10]</code> → Lua: table / JS: Array / C#: int[]</li><li>需要处理：长度信息、内存拷贝 vs 引用</li></ul></li><li><p><strong>结构体</strong>：</p><ul><li>C: <code>struct Point { float x, y; }</code> → Lua: table / JS: object / C#: struct</li><li>需要处理：内存布局、对齐、字节序</li></ul></li><li><p><strong>函数指针</strong>：</p><ul><li>C: <code>void (*callback)(int)</code> → Lua: function / JS: function / C#: delegate</li><li>需要处理：闭包捕获、生命周期</li></ul></li><li><p><strong>对象</strong>：</p><ul><li>C++: <code>class Player</code> → Lua: userdata + metatable / JS: object / C#: class</li><li>需要处理：继承、多态、虚函数</li></ul></li></ol><h2 id="三、实现机制" tabindex="-1">三、实现机制 <a class="header-anchor" href="#三、实现机制" aria-label="Permalink to &quot;三、实现机制&quot;">​</a></h2><h3 id="_3-1-运行时桥接机制" tabindex="-1">3.1 运行时桥接机制 <a class="header-anchor" href="#_3-1-运行时桥接机制" aria-label="Permalink to &quot;3.1 运行时桥接机制&quot;">​</a></h3><h4 id="跨语言调用链的完整流程" tabindex="-1">跨语言调用链的完整流程 <a class="header-anchor" href="#跨语言调用链的完整流程" aria-label="Permalink to &quot;跨语言调用链的完整流程&quot;">​</a></h4><p>一次完整的跨语言调用涉及多个层次的转换。以 Lua 调用 C++ 为例：</p><div class="language-"><button title="Copy code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span>Lua 脚本代码</span></span>
<span class="line"><span>    ↓</span></span>
<span class="line"><span>Lua VM（解释执行字节码）</span></span>
<span class="line"><span>    ↓</span></span>
<span class="line"><span>Lua C API（栈操作）</span></span>
<span class="line"><span>    ↓</span></span>
<span class="line"><span>绑定层（Wrapper/Binding）</span></span>
<span class="line"><span>    ↓</span></span>
<span class="line"><span>C++ 对象方法</span></span>
<span class="line"><span>    ↓</span></span>
<span class="line"><span>返回值</span></span>
<span class="line"><span>    ↓</span></span>
<span class="line"><span>绑定层（类型转换）</span></span>
<span class="line"><span>    ↓</span></span>
<span class="line"><span>Lua C API（压栈）</span></span>
<span class="line"><span>    ↓</span></span>
<span class="line"><span>Lua VM（继续执行）</span></span>
<span class="line"><span>    ↓</span></span>
<span class="line"><span>Lua 脚本代码</span></span></code></pre><button class="code-block-unfold-btn"></button></div><p><strong>详细流程</strong>：</p><ol><li><p><strong>Lua 脚本调用</strong>：</p><div class="language-lua"><button title="Copy code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> player</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">Attack</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(target, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span></span></code></pre><button class="code-block-unfold-btn"></button></div></li><li><p><strong>Lua VM 查找方法</strong>：</p><ul><li>检查 <code>player</code> 的元表（metatable）</li><li>在元表的 <code>__index</code> 中查找 <code>Attack</code> 方法</li><li>找到对应的 C 函数指针</li></ul></li><li><p><strong>调用 C 绑定函数</strong>：</p><div class="language-cpp"><button title="Copy code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> lua_Player_Attack</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">lua_State</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> L</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    // 从 Lua 栈获取参数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    Player</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> self </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (Player</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">luaL_checkudata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(L, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"Player"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    Player</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> target </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (Player</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">luaL_checkudata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(L, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"Player"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> damage </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> luaL_checkinteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(L, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    // 调用 C++ 方法</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">self)-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">Attack</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">target, damage);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    // 返回值数量</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div></li><li><p><strong>执行 C++ 代码</strong>：</p><div class="language-cpp"><button title="Copy code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Player</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">Attack</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">Player</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> target</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> damage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    target-&gt;health_ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">-=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> damage;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div></li><li><p><strong>返回到 Lua</strong>：</p><ul><li>绑定函数返回</li><li>Lua VM 从栈上获取返回值</li><li>继续执行 Lua 代码</li></ul></li></ol><h4 id="各个环节的职责和实现细节" tabindex="-1">各个环节的职责和实现细节 <a class="header-anchor" href="#各个环节的职责和实现细节" aria-label="Permalink to &quot;各个环节的职责和实现细节&quot;">​</a></h4><p>跨语言调用链中的各个环节分工明确：</p><ul><li><strong>脚本代码</strong>：负责业务逻辑，使用高级语言语法，易读易写</li><li><strong>虚拟机</strong>：负责解释执行，包括字节码解释、JIT 编译、内存管理</li><li><strong>语言 API</strong>：负责栈操作，提供 C API 操作虚拟机栈</li><li><strong>绑定层</strong>：负责类型转换，包括参数解封、调用原生函数、结果封送</li><li><strong>原生代码</strong>：负责核心逻辑，执行高性能计算、系统调用</li></ul><h4 id="不同语言桥接方案的差异对比" tabindex="-1">不同语言桥接方案的差异对比 <a class="header-anchor" href="#不同语言桥接方案的差异对比" aria-label="Permalink to &quot;不同语言桥接方案的差异对比&quot;">​</a></h4><h5 id="lua-的-c-api-桥接" tabindex="-1">Lua 的 C API 桥接 <a class="header-anchor" href="#lua-的-c-api-桥接" aria-label="Permalink to &quot;Lua 的 C API 桥接&quot;">​</a></h5><p><strong>特点</strong>：基于栈的设计，简单但需要手动管理栈。</p><div class="language-cpp"><button title="Copy code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// 注册 C 函数到 Lua</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">lua_pushcfunction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(L, my_c_function);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">lua_setglobal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(L, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"myFunction"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// C 函数实现</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> my_c_function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">lua_State</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> L</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> arg1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> lua_tointeger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(L, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  // 获取第一个参数</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> char*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> arg2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> lua_tostring</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(L, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  // 获取第二个参数</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    // 执行逻辑</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> arg1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> strlen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(arg2);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    // 压入返回值</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    lua_pushinteger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(L, result);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  // 返回值数量</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><h5 id="javascript-typescript-的桥接-v8-嵌入式-embedding" tabindex="-1">JavaScript/TypeScript 的桥接（V8 嵌入式 Embedding） <a class="header-anchor" href="#javascript-typescript-的桥接-v8-嵌入式-embedding" aria-label="Permalink to &quot;JavaScript/TypeScript 的桥接（V8 嵌入式 Embedding）&quot;">​</a></h5><p><strong>特点</strong>：直接嵌入 V8 引擎，使用 V8 C++ API 将 C/C++ 函数暴露为 JS 函数；可脱离 Node.js 运行时，适合游戏/嵌入式脚本场景。</p><div class="language-cpp"><button title="Copy code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> &lt;v8.h&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> &lt;libplatform/libplatform.h&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">using</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> namespace</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> v8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// C++ -&gt; JS 函数绑定</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> MyFunctionCallback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> FunctionCallbackInfo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">Value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> args</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    Isolate</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> isolate </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> args.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">GetIsolate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    Local</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">Context</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> ctx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> isolate-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">GetCurrentContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    int32_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> args[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">]-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">Int32Value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(ctx).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">FromMaybe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">::Utf8Value </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(isolate, args[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">]);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (s.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">length</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">strlen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">s) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    args.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">GetReturnValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">Set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">Integer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">New</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(isolate, result));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> argc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">char**</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> argv</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    // 初始化 V8 平台</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    V8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">InitializeICUDefaultLocation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(argv[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">]);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    V8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">InitializeExternalStartupData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(argv[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">]);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    std</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">::unique_ptr</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">Platform</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> platform </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> platform</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">NewDefaultPlatform</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    V8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">InitializePlatform</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(platform.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">());</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    V8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">Initialize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    Isolate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">::CreateParams params;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    params.array_buffer_allocator </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> ArrayBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">Allocator</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">NewDefaultAllocator</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    Isolate</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> isolate </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Isolate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">New</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(params);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">        Isolate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">::Scope </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">isolate_scope</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(isolate);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        HandleScope </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">handle_scope</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(isolate);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        // 构建上下文并注册全局函数 myFunction</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        Local</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">ObjectTemplate</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> global </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> ObjectTemplate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">New</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(isolate);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        global-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">Set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">NewFromUtf8Literal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(isolate, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"myFunction"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">),</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">                    FunctionTemplate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">New</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(isolate, MyFunctionCallback));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        Local</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">Context</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> context </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">New</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(isolate, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">nullptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, global);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">        Context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">::Scope </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">context_scope</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(context);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        // 执行 JS 调用</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        Local</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">String</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> source </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">NewFromUtf8Literal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(isolate, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"myFunction(42, 'hello')"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        Local</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">Script</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> script </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Script</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">Compile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(context, source).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">ToLocalChecked</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        Local</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">Value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> script-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">Run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(context).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">ToLocalChecked</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">        printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">%d\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, result-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">Int32Value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(context).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">FromMaybe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    isolate-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">Dispose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    V8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">Dispose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    V8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">ShutdownPlatform</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    delete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> params.array_buffer_allocator;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><h5 id="c-的-p-invoke-和-c-cli" tabindex="-1">C# 的 P/Invoke 和 C++/CLI <a class="header-anchor" href="#c-的-p-invoke-和-c-cli" aria-label="Permalink to &quot;C# 的 P/Invoke 和 C++/CLI&quot;">​</a></h5><p><strong>P/Invoke</strong>（调用 C 函数）</p><div class="language-csharp"><button title="Copy code" class="copy"></button><span class="lang">csharp</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">using</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> System</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">using</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> System</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">Runtime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">InteropServices</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Program</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    // 声明外部函数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    [</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">DllImport</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"mylib.dll"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">CallingConvention</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> CallingConvention.Cdecl)]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> extern</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> my_function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> arg1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">string</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> arg2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> my_function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">42</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"hello"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        Console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">WriteLine</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(result);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><p><strong>C++/CLI</strong>（混合编程）</p><div class="language-cpp"><button title="Copy code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// ManagedWrapper.cpp</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "NativeClass.h"</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">using</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> namespace</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> System</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">public ref </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> ManagedWrapper</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">private:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    NativeClass</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> native;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">public:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    ManagedWrapper</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        native </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> NativeClass</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    ~ManagedWrapper</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        delete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> native;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> MyMethod</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> arg1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">String</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">^</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> arg2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        // 转换 String^ 为 std::string</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        IntPtr ptr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Marshal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">StringToHGlobalAnsi</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(arg2);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">        std</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">::string str </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> static_cast&lt;char*&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(ptr.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">ToPointer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">());</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">        Marshal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">FreeHGlobal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(ptr);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> native-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">MyMethod</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(arg1, str);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">};</span></span></code></pre><button class="code-block-unfold-btn"></button></div><h3 id="_3-2-调用约定" tabindex="-1">3.2 调用约定 <a class="header-anchor" href="#_3-2-调用约定" aria-label="Permalink to &quot;3.2 调用约定&quot;">​</a></h3><h4 id="调用约定的基本概念" tabindex="-1">调用约定的基本概念 <a class="header-anchor" href="#调用约定的基本概念" aria-label="Permalink to &quot;调用约定的基本概念&quot;">​</a></h4><p>调用约定（Calling Convention）定义了函数调用时的底层细节，包括：</p><ul><li>参数如何传递（寄存器还是栈）</li><li>返回值如何传递</li><li>谁负责清理栈（调用者还是被调用者）</li><li>寄存器的保存和恢复规则</li></ul><p><strong>跨语言调用时，调用约定必须匹配</strong>，否则会导致栈损坏、参数错误等严重问题。</p><h4 id="参数传递和返回值机制" tabindex="-1">参数传递和返回值机制 <a class="header-anchor" href="#参数传递和返回值机制" aria-label="Permalink to &quot;参数传递和返回值机制&quot;">​</a></h4><h5 id="不同架构的调用约定" tabindex="-1">不同架构的调用约定 <a class="header-anchor" href="#不同架构的调用约定" aria-label="Permalink to &quot;不同架构的调用约定&quot;">​</a></h5><p><strong>32 位 x86 架构</strong>：</p><ol><li><p><strong>cdecl</strong>（C Declaration）：</p><ul><li>参数从右到左压栈</li><li>调用者清理栈</li><li>返回值在 <code>eax</code> 寄存器</li></ul><div class="language-asm"><button title="Copy code" class="copy"></button><span class="lang">asm</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">; int add(int a, int b)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">; 调用 add(10, 20)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">push</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 20</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        ; 参数 b</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">push</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 10</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        ; 参数 a</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">call</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> add</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">       ; 调用函数</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">add</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> esp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">8</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">     ; 调用者清理栈（2 个参数 × 4 字节）</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">; 返回值在 eax</span></span></code></pre><button class="code-block-unfold-btn"></button></div></li><li><p><strong>stdcall</strong>（Standard Call）：</p><ul><li>参数从右到左压栈</li><li>被调用者清理栈</li><li>Windows API 常用</li></ul><div class="language-asm"><button title="Copy code" class="copy"></button><span class="lang">asm</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">; int __stdcall add(int a, int b)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">push</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 20</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">push</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 10</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">call</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> add</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">       ; 函数内部会清理栈</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">; 不需要调用者清理</span></span></code></pre><button class="code-block-unfold-btn"></button></div></li><li><p><strong>fastcall</strong>：</p><ul><li>前两个参数通过 <code>ecx</code> 和 <code>edx</code> 寄存器传递</li><li>其余参数压栈</li><li>被调用者清理栈</li></ul><div class="language-asm"><button title="Copy code" class="copy"></button><span class="lang">asm</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">; int __fastcall add(int a, int b, int c)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">mov</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> ecx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">10</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    ; 第一个参数</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">mov</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> edx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">20</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    ; 第二个参数</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">push</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 30</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        ; 第三个参数</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">call</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> add</span></span></code></pre><button class="code-block-unfold-btn"></button></div></li></ol><p><strong>64 位 x86-64 架构</strong>：</p><p>64 位系统统一了调用约定，大量使用寄存器传参，性能更高。</p><ol><li><p><strong>Windows x64 调用约定</strong>：</p><ul><li>前 4 个整数/指针参数：<code>rcx</code>, <code>rdx</code>, <code>r8</code>, <code>r9</code></li><li>前 4 个浮点参数：<code>xmm0</code>, <code>xmm1</code>, <code>xmm2</code>, <code>xmm3</code></li><li>其余参数压栈</li><li>调用者分配 32 字节"影子空间"（shadow space）</li><li>返回值在 <code>rax</code>（整数）或 <code>xmm0</code>（浮点）</li></ul><div class="language-asm"><button title="Copy code" class="copy"></button><span class="lang">asm</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">; int add(int a, int b, int c, int d, int e)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">; 调用 add(1, 2, 3, 4, 5)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">sub</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> rsp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">40</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    ; 分配影子空间（32）+ 第 5 个参数（8）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">mov</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> ecx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">1</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">     ; 参数 a</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">mov</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> edx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">2</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">     ; 参数 b</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">mov</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> r8d</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">3</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">     ; 参数 c</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">mov</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> r9d</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">4</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">     ; 参数 d</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">mov</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">rsp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">], </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">5</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  ; 参数 e（栈上）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">call</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> add</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">add</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> rsp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">40</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    ; 清理栈</span></span></code></pre><button class="code-block-unfold-btn"></button></div></li><li><p><strong>System V AMD64 ABI</strong>（Linux、macOS）：</p><ul><li>前 6 个整数/指针参数：<code>rdi</code>, <code>rsi</code>, <code>rdx</code>, <code>rcx</code>, <code>r8</code>, <code>r9</code></li><li>前 8 个浮点参数：<code>xmm0</code>-<code>xmm7</code></li><li>其余参数压栈</li><li>无影子空间</li><li>返回值在 <code>rax</code>/<code>xmm0</code></li></ul><div class="language-asm"><button title="Copy code" class="copy"></button><span class="lang">asm</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">; 调用 add(1, 2, 3, 4, 5, 6, 7)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">mov</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> edi</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">1</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">     ; 参数 1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">mov</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> esi</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">2</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">     ; 参数 2</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">mov</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> edx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">3</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">     ; 参数 3</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">mov</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> ecx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">4</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">     ; 参数 4</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">mov</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> r8d</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">5</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">     ; 参数 5</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">mov</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> r9d</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">6</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">     ; 参数 6</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">push</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 7</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">         ; 参数 7（栈上）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">call</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> add</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">add</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> rsp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">8</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">     ; 清理栈</span></span></code></pre><button class="code-block-unfold-btn"></button></div></li></ol><h5 id="返回值的传递机制" tabindex="-1">返回值的传递机制 <a class="header-anchor" href="#返回值的传递机制" aria-label="Permalink to &quot;返回值的传递机制&quot;">​</a></h5><p><strong>简单类型</strong>：</p><ul><li>整数、指针：<code>rax</code>（64位）或 <code>eax</code>（32位）</li><li>浮点数：<code>xmm0</code></li><li>布尔值：<code>al</code>（<code>rax</code> 的低 8 位）</li></ul><p><strong>复杂类型</strong>：</p><ol><li><p><strong>小结构体</strong>（≤ 16 字节）：</p><ul><li>Windows x64：通过隐藏的指针参数返回（调用者分配空间）</li><li>System V AMD64：通过 <code>rax</code> 和 <code>rdx</code> 返回（最多 16 字节）</li></ul><div class="language-cpp"><button title="Copy code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Point</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> { </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> x, y; };</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  // 8 字节</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">Point</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> GetPoint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">};</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// System V AMD64：</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// rax = 0x0000001400000014  (低 32 位是 x，高 32 位是 y)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// Windows x64：</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// 调用者传递隐藏参数（指向返回值的指针）</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// void GetPoint(Point* __return);</span></span></code></pre><button class="code-block-unfold-btn"></button></div></li><li><p><strong>大结构体</strong>（&gt; 16 字节）：</p><ul><li>调用者分配空间</li><li>将指针作为隐藏的第一个参数传递</li><li>被调用者将结果写入该地址</li></ul><div class="language-cpp"><button title="Copy code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> BigStruct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> { </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> data[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">]; };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">BigStruct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> GetBigStruct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    BigStruct result;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    // ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> result;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// 实际编译为：</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// void GetBigStruct(BigStruct* __return) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">//</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">     // 填充 __return</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// }</span></span></code></pre><button class="code-block-unfold-btn"></button></div></li></ol><h5 id="栈的清理责任划分" tabindex="-1">栈的清理责任划分 <a class="header-anchor" href="#栈的清理责任划分" aria-label="Permalink to &quot;栈的清理责任划分&quot;">​</a></h5><p>不同调用约定的栈清理责任和特点：</p><ul><li><strong>cdecl</strong>：调用者负责清理栈。优点是支持可变参数（如 printf），缺点是代码体积大（每个调用点都有清理代码）</li><li><strong>stdcall</strong>：被调用者负责清理栈。优点是代码体积小，缺点是不支持可变参数</li><li><strong>fastcall</strong>：被调用者负责清理栈。优点是性能高（寄存器传参），缺点是参数数量有限</li><li><strong>x64</strong>：调用者负责清理栈。优点是统一标准</li></ul><p><strong>为什么 cdecl 支持可变参数？</strong></p><div class="language-c"><button title="Copy code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> char*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> format</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, ...);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// 调用</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">%d</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> %s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">42</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"hello"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span></code></pre><button class="code-block-unfold-btn"></button></div><p>被调用者（<code>printf</code>）不知道有多少个参数，因此无法清理栈。只有调用者知道传递了多少参数，所以必须由调用者清理。</p><h3 id="_3-3-平台和编译器的-abi-差异" tabindex="-1">3.3 平台和编译器的 ABI 差异 <a class="header-anchor" href="#_3-3-平台和编译器的-abi-差异" aria-label="Permalink to &quot;3.3 平台和编译器的 ABI 差异&quot;">​</a></h3><h4 id="windows-vs-linux-vs-macos" tabindex="-1">Windows vs Linux vs macOS <a class="header-anchor" href="#windows-vs-linux-vs-macos" aria-label="Permalink to &quot;Windows vs Linux vs macOS&quot;">​</a></h4><p>不同平台的 ABI 差异：</p><ul><li><strong>调用约定</strong>：Windows 使用 Windows x64，Linux 和 macOS 使用 System V AMD64</li><li><strong>参数寄存器</strong>：Windows 使用 rcx、rdx、r8、r9；Linux/macOS 使用 rdi、rsi、rdx、rcx、r8、r9</li><li><strong>栈对齐</strong>：所有平台都要求 16 字节对齐</li><li><strong>动态库扩展名</strong>：Windows 使用 .dll，Linux 使用 .so，macOS 使用 .dylib</li><li><strong>符号导出</strong>：Windows 使用 <code>__declspec(dllexport)</code>，Linux/macOS 使用 <code>__attribute__((visibility("default")))</code></li><li><strong>C++ name mangling</strong>：Windows 使用 MSVC 风格，Linux/macOS 使用 Itanium ABI</li></ul><p><strong>跨平台兼容性问题</strong>：</p><div class="language-cpp"><button title="Copy code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// 错误：假设 Windows 调用约定</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">#ifdef</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> _WIN32</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">__declspec(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">dllexport</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">#endif</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// 正确：使用 extern "C" 避免 name mangling</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">extern</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "C"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">#ifdef</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> _WIN32</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    __declspec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(dllexport)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">#else</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    __attribute__</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">((</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">visibility</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">"default"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">#endif</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><h4 id="msvc-vs-gcc-vs-clang" tabindex="-1">MSVC vs GCC vs Clang <a class="header-anchor" href="#msvc-vs-gcc-vs-clang" aria-label="Permalink to &quot;MSVC vs GCC vs Clang&quot;">​</a></h4><p>不同编译器会存在 ABI 差异：</p><ul><li><strong>MSVC</strong>：使用专有的 C++ ABI，Name Mangling 格式如 <code>?add@@YAHHH@Z</code>，仅与 MSVC 编译的代码兼容</li><li><strong>GCC</strong>：使用 Itanium C++ ABI，Name Mangling 格式如 <code>_Z3addii</code>，与 Clang 兼容</li><li><strong>Clang</strong>：使用 Itanium C++ ABI，Name Mangling 格式如 <code>_Z3addii</code>，与 GCC 兼容</li></ul><p><strong>Name Mangling 示例</strong>：</p><div class="language-cpp"><button title="Copy code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">double</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">double</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">  // 重载</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// MSVC：</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// ?add@@YAHHH@Z</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// ?add@@YANNN@Z</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// GCC/Clang：</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// _Z3addii</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// _Z3adddd</span></span></code></pre><button class="code-block-unfold-btn"></button></div><p><strong>解决方案</strong>：使用 <code>extern "C"</code> 禁用 name mangling</p><div class="language-cpp"><button title="Copy code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">extern</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> "C"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> add_int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    double</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> add_double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">double</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">double</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// 编译后：</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// add_int</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// add_double</span></span></code></pre><button class="code-block-unfold-btn"></button></div><!--]--></div><!--[--><!--]--><!--[--><!--]--><!--]--><!----><!----></article></template><!--]--><!--[--><!--]--><!--[--><!--]--><!--[--><!--]--><!----><!--[--><!--[--><footer class="sakura-post-footer" data-v-f99429f0><!--[--><div class="sakura-post-nav flex" data-v-f99429f0 data-v-fcca7734><!----><div class="sakura-image-card relative overflow-hidden card-next rounded-$sakura-radius" data-v-fcca7734 data-v-8692e20a><a href="/posts/lua-depth" class="va-link" flex="~" w="full" h="full" aria-label="Go to Post" data-v-8692e20a><!--[--><!----><div class="h-full w-full bg-$sakura-color-background opacity-70" style="transition:transform var(--va-transition-duration) ease,opacity var(--va-transition-duration) ease" flex="~ center" data-v-8692e20a><div i-fa6-solid-image w="30%" h="30%" data-v-8692e20a></div></div><div class="sakura-image-card-overlay" style="opacity:.5;background-color:rgba(0,0,0,.5)" data-v-8692e20a></div></a><div class="absolute top-0 h-full w-full" data-v-8692e20a><a href="/posts/lua-depth" class="va-link" flex="~" w="full" h="full" aria-label="Go to Post" data-v-8692e20a><!--[--></a><div class="sakura-post-nav-content" data-v-fcca7734><a href="/posts/lua-depth" class="va-link" flex="~" w="full" h="full" aria-label="Go to Post" data-v-8692e20a><span flex justify-end class="sakura-post-nav-label" data-v-fcca7734>Next Post </span></a><a href="/posts/lua-depth" class="sakura-post-nav-title" flex justify-end data-v-fcca7734>LuaDepth</a></div><!--]--></div><!--]--></div></div><!--]--><!--[--><div class="py-8" data-v-f99429f0><a href="/" class="link" data-v-f99429f0>← Back to the blog</a></div><!--]--></footer><!--]--><!--]--><!--]--><!--]--><!--]--><!--[--><!--]--></div><!--]--></div><aside><!--[--><!--[--><!--[--><!--[--><!-- <div class="sakura-aside sakura-card <md:hidden" p="x-2"> --><div class="sakura-aside <md:hidden" data-v-aead835b><!--[--><!--[--><h2 font="serif black" data-v-ccb9bf74>文章目录</h2><div class="custom-container" data-v-ccb9bf74><!--[--><div data-v-ccb9bf74 style="display:none" data-v-a0b02666><div class="content" data-v-a0b02666><div class="outline-title" data-v-a0b02666>On this page</div><div class="outline-marker" data-v-a0b02666></div><nav aria-labelledby="doc-outline-aria-label" data-v-a0b02666><span id="doc-outline-aria-label" class="visually-hidden" data-v-a0b02666>Table of Contents for current page</span><ul class="root va-toc css-i18n-toc va-toc css-i18n-toc relative z-1" data-v-a0b02666 data-v-81d0e566><!--[--><!--]--></ul></nav></div></div><!--]--></div><!--]--><!--]--></div><!--]--><!--]--><!--]--><!--]--></aside></div><!----><!----><!----><!--]--></article><!--]--></main><!--[--><!----><!--]--><!--[--><footer class="sakura-footer h-$sakura-footer-height sakura-sidebar-offset" text="center sm" style="color:var(--va-c-text-light)" data-v-73ded2f2><!----><div class="sakura-copyright copyright flex items-center justify-center" p="1"><span>Copyright © <span itemprop="copyrightYear"><!--[-->2023 -<!--]--> 2025</span></span><!----><!----><span itemprop="copyrightHolder">whisper3zzz</span></div><div class="powered" m="2" translate="no"><span>由 <a href="git+https://github.com/YunYouJun/valaxy.git" target="_blank" rel="noopener">Valaxy</a> v0.26.6 驱动</span> | <span>主题 <a href="https://github.com/WRXinYue/valaxy-theme-sakura" title="valaxy-theme-sakura" target="_blank">Sakura</a> v0.10.2</span></div><!--[--><!--]--></footer><!--]--><!-- <SakuraChangSkin /> --></div><!--]--><!--]--><!--[--><!--[--><!-- eslint-disable-next-line vue/component-name-in-template-casing --><meting-js id="2145269432" server="netease" type="song" fixed="true" autoplay style></meting-js><!--]--><!--]--><!----><!--]--></div><script>window.__INITIAL_STATE__='{"pinia":{"app":{"showLoading":true},"sakura-app":{"positions":{},"loadMultiple":1,"paginationTargets":[],"paginationElementPositionsNumber":0,"wallpaperIndex":0,"wallpaperLength":0,"wallpaperIsPlaying":false},"site":{},"routerStore":{}}}'</script><script type="application/ld+json" data-hid="schema-org-graph">{"@context":"https://schema.org","@graph":[{"@id":"https://whisper3zzz.top/#identity","@type":"Person","name":"whisper3zzz","url":"https://whisper3zzz.top/","image":{"@id":"https://whisper3zzz.top/#/schema/image/6b28583"},"sameAs":["https://github.com/whisper3zzz","https://music.163.com/#/user/home?id=247102977","https://space.bilibili.com/1579790","mailto:whisper3zzz@qq.com"]},{"@id":"https://whisper3zzz.top/#website","@type":"WebSite","dateModified":"2025-12-18T13:11:53.303Z","datePublished":"2025-10-29","inLanguage":"en","name":"漫谈跨语言调用","url":"https://whisper3zzz.top/","publisher":{"@id":"https://whisper3zzz.top/#identity"}},{"@id":"https://whisper3zzz.top/#webpage","@type":"WebPage","dateModified":"2025-12-18","datePublished":"2025-10-29","description":"whisper3zzzの小窝","name":"漫谈跨语言调用","url":"https://whisper3zzz.top/","about":{"@id":"https://whisper3zzz.top/#identity"},"isPartOf":{"@id":"https://whisper3zzz.top/#website"},"potentialAction":[{"@type":"ReadAction","target":["https://whisper3zzz.top/"]}]},{"@id":"https://whisper3zzz.top/#article","dateModified":"2025-12-18","datePublished":"2025-10-29","description":"whisper3zzzの小窝","headline":"漫谈跨语言调用","inLanguage":"en","thumbnailUrl":"https://whisper3zzz.top/favicon.svg","@type":["Article","BlogPosting"],"author":{"@id":"https://whisper3zzz.top/#/schema/person/2d37fcb"},"image":{"@id":"https://whisper3zzz.top/#/schema/image/ab5cdb"},"isPartOf":{"@id":"https://whisper3zzz.top/#webpage"},"mainEntityOfPage":{"@id":"https://whisper3zzz.top/#webpage"},"publisher":{"@id":"https://whisper3zzz.top/#identity"}},{"@id":"https://whisper3zzz.top/#/schema/person/2d37fcb","@type":"Person","name":"whisper3zzz","url":"https://valaxy.site"},{"@id":"https://whisper3zzz.top/#/schema/image/6b28583","@type":"ImageObject","contentUrl":"https://valaxy.site/valaxy-logo.png","inLanguage":"en","url":"https://valaxy.site/valaxy-logo.png"},{"@id":"https://whisper3zzz.top/#/schema/image/ab5cdb","@type":"ImageObject","contentUrl":"https://whisper3zzz.top/favicon.svg","inLanguage":"en","url":"https://whisper3zzz.top/favicon.svg"}]}</script></body></html>